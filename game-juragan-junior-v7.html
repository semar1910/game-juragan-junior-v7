<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saudagar Cilik Nusantara</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a5a2e 0%, #2d8a4e 100%); min-height: 100vh; overflow-x: hidden; }
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.3s ease; }
        .screen.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ========== TOP BAR GLOBAL ========== */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: linear-gradient(135deg, #1a5a2e, #2d8a4e);
            padding: 8px 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .mini-profile {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.15); padding: 6px 12px;
            border-radius: 25px; cursor: pointer; transition: all 0.2s; color: white;
        }
        .mini-profile:hover { background: rgba(255,255,255,0.25); }
        .mini-profile-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .mini-profile-info { display: flex; flex-direction: column; line-height: 1.2; }
        .mini-profile-name { font-size: 0.8rem; font-weight: bold; }
        .mini-profile-rank { font-size: 0.65rem; opacity: 0.85; }
        .mini-leaderboard { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 20px; cursor: pointer; transition: all 0.2s; color: white; }
        .mini-leaderboard:hover { background: rgba(255,255,255,0.2); }
        .mini-lb-items { display: flex; gap: 5px; }
        .mini-lb-item { display: flex; align-items: center; gap: 3px; font-size: 0.7rem; padding: 3px 8px; border-radius: 12px; }
        .mini-lb-item.gold { background: rgba(255,215,0,0.3); }
        .mini-lb-item.silver { background: rgba(192,192,192,0.3); }
        .mini-lb-item.bronze { background: rgba(205,127,50,0.3); }

        /* ========== TITLE SCREEN (FULLSCREEN BACKGROUND) ========== */
        .title-screen { 
            justify-content: flex-end; align-items: flex-end; 
            padding: 40px; padding-bottom: 80px;
            background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/title-screen.png');
            background-size: cover; background-position: center; background-repeat: no-repeat;
            position: relative;
        }
        .title-screen::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
        }
        .title-content {
            position: relative; z-index: 2; text-align: right;
            max-width: 500px; margin-left: auto;
        }
        .title-main {
            font-family: 'Segoe UI Black', 'Arial Black', sans-serif;
            font-size: 3.5rem; font-weight: 900; color: #FFD700;
            text-shadow: 4px 4px 0px #1a5a2e, 6px 6px 0px rgba(0,0,0,0.3), 0 0 30px rgba(255,215,0,0.5);
            letter-spacing: 3px; margin-bottom: 5px;
            animation: titlePulse 2s ease-in-out infinite;
        }
        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .title-sub {
            font-family: 'Georgia', serif; font-size: 1.3rem; color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-style: italic; margin-bottom: 30px; letter-spacing: 1px;
        }
        .btn-start {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
            color: #1a5a2e; border: none; padding: 18px 45px;
            font-size: 1.3rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 6px 25px rgba(0,0,0,0.4), inset 0 2px 0 rgba(255,255,255,0.3);
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 2px;
            border: 3px solid #1a5a2e;
        }
        .btn-start:hover { transform: scale(1.05) translateY(-3px); box-shadow: 0 10px 35px rgba(0,0,0,0.5); }
        .btn-start:active { transform: scale(0.98); }
        
        .btn { background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; padding: 18px 50px; font-size: 1.4rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.3); transition: all 0.2s; margin: 8px; }
        .btn:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: white; color: #1a5a2e; padding: 15px 40px; font-size: 1.2rem; }

        /* ========== MAIN MENU / LEVEL SELECT ========== */
        .main-screen { padding-top: 60px; background: linear-gradient(135deg, #1a5a2e 0%, #2d8a4e 100%); }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .menu-card { background: white; border-radius: 30px; padding: 25px; max-width: 450px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .level-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        .level-btn { aspect-ratio: 1; border-radius: 15px; border: none; font-size: 1.3rem; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; }
        .level-btn.unlocked { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .level-btn.locked { background: #e0e0e0; color: #999; cursor: not-allowed; }
        .level-btn:hover:not(.locked) { transform: scale(1.1); }
        .level-btn-stars { font-size: 0.7rem; }
        
        /* ISLAND TABS */
        .island-tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .island-tab { flex: 1; min-width: 70px; padding: 10px 5px; border: none; background: #f0f0f0; color: #666; font-size: 0.8rem; font-weight: bold; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .island-tab.active { background: linear-gradient(135deg, #1a5a2e, #2d8a4e); color: white; }
        .island-tab:hover:not(.active):not(.locked) { background: #e0e0e0; }
        .island-tab.locked { opacity: 0.5; cursor: not-allowed; }
        .island-tab-icon-img { width: 40px; height: 40px; object-fit: contain; }
        .island-tab.locked .island-tab-icon-img { filter: grayscale(100%); }
        .island-tab-name { font-size: 0.65rem; }
        .island-content { display: none; animation: fadeIn 0.3s ease; }
        .island-content.active { display: block; }

        /* ========== PROFILE SCREEN ========== */
        .profile-screen { padding-top: 60px; align-items: center; padding: 20px; background: linear-gradient(135deg, #1a5a2e 0%, #2d8a4e 100%); }
        .profile-card { background: white; border-radius: 30px; padding: 30px; max-width: 450px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .profile-header { text-align: center; margin-bottom: 25px; }
        .profile-avatar { width: 100px; height: 100px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; margin: 0 auto 15px; box-shadow: 0 5px 20px rgba(255,165,0,0.4); }
        .profile-name input { font-size: 1.5rem; text-align: center; border: none; border-bottom: 2px dashed #ddd; outline: none; width: 200px; padding: 5px; }
        .profile-name input:focus { border-bottom-color: #1a5a2e; }
        .profile-title { display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 20px; border-radius: 20px; font-size: 1rem; font-weight: bold; margin-top: 10px; }
        .profile-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .profile-stat { background: #f9f9f9; padding: 20px; border-radius: 20px; text-align: center; }
        .profile-stat-icon { font-size: 2rem; margin-bottom: 8px; }
        .profile-stat-value { font-size: 1.8rem; font-weight: bold; color: #1a5a2e; }
        .profile-stat-label { font-size: 0.85rem; color: #888; }
        .rank-badge { display: flex; align-items: center; gap: 15px; background: linear-gradient(135deg, #FFF8E1, #FFECB3); padding: 15px 20px; border-radius: 20px; margin-bottom: 20px; }
        .rank-badge-icon { font-size: 2.5rem; }
        .rank-badge-info h4 { color: #333; margin-bottom: 3px; }
        .rank-badge-info p { color: #888; font-size: 0.85rem; }

        /* ========== LEADERBOARD SCREEN ========== */
        .leaderboard-screen { padding-top: 60px; align-items: center; padding: 20px; background: linear-gradient(135deg, #1a5a2e 0%, #2d8a4e 100%); }
        .leaderboard-card { background: white; border-radius: 30px; padding: 25px; max-width: 450px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .leaderboard-title { text-align: center; font-size: 1.5rem; color: #1a5a2e; margin-bottom: 20px; }
        .leaderboard-list { max-height: 350px; overflow-y: auto; }
        .leaderboard-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; background: #f9f9f9; border-radius: 15px; margin-bottom: 10px; }
        .leaderboard-item.current-player { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border: 2px solid #4CAF50; }
        .leaderboard-rank { font-size: 1.5rem; font-weight: bold; width: 35px; text-align: center; }
        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }
        .leaderboard-avatar { width: 45px; height: 45px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: bold; color: #333; }
        .leaderboard-title-small { font-size: 0.8rem; color: #888; }
        .leaderboard-coins { font-weight: bold; color: #F5A623; font-size: 1.1rem; }

        /* ========== GAME SCREEN ========== */
        .game-screen { background: #e8f4e8; padding-top: 60px; }
        .mission-panel { background: white; margin: 15px; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .mission-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .mission-icon { font-size: 3rem; }
        .mission-info h2 { font-size: 1.3rem; color: #1a5a2e; margin-bottom: 5px; }
        .mission-info p { color: #666; font-size: 1rem; }
        .mission-phase { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .phase-step { flex: 1; min-width: 70px; text-align: center; padding: 10px; border-radius: 15px; background: #f5f5f5; font-size: 0.85rem; }
        .phase-step.active { background: #FFD700; font-weight: bold; }
        .phase-step.done { background: #4CAF50; color: white; }
        .phase-step-icon { font-size: 1.3rem; display: block; margin-bottom: 5px; }

        /* ========== MAP ========== */
        .map-container { flex: 1; margin: 0 15px 15px; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .map-title { text-align: center; font-size: 1.2rem; color: #1a5a2e; margin-bottom: 15px; }
        .map-area { 
            position: relative; width: 100%; height: 280px; 
            border-radius: 15px; overflow: hidden;
            background-size: cover; background-position: center;
            background-repeat: no-repeat;
        }
        /* Background per pulau */
        .map-area.map-jawa { background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/bg-jawa.png'); }
        .map-area.map-sumatera { background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/bg-sumatera.png'); }
        .map-area.map-kalimantan { background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/bg-kalimantan.png'); }
        .map-area.map-sulawesi { background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/bg-sulawesi.png'); }
        .map-area.map-papua { background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/bg-papua.png'); }
        
        /* Overlay gradient untuk kontras */
        .map-area::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.15) 100%);
            z-index: 0; pointer-events: none;
        }
        
        .map-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Route lines dengan animasi */
        .route-line { 
            stroke: rgba(100,100,100,0.6); stroke-width: 4; 
            stroke-dasharray: 12,8; stroke-linecap: round; fill: none;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
        }
        .route-line.selected { 
            stroke: #4CAF50; stroke-width: 6; 
            stroke-dasharray: none; opacity: 1;
            filter: drop-shadow(0 0 8px rgba(76,175,80,0.6));
            animation: routeGlow 1.5s ease-in-out infinite;
        }
        @keyframes routeGlow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(76,175,80,0.4)); }
            50% { filter: drop-shadow(0 0 15px rgba(76,175,80,0.8)); }
        }
        
        /* Route cost label */
        .route-cost-label { 
            position: absolute; background: rgba(255,255,255,0.95); 
            padding: 4px 10px; border-radius: 12px; 
            font-size: 0.75rem; font-weight: bold; color: #666; 
            z-index: 2; transform: translate(-50%, -50%); 
            border: 2px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .route-cost-label.selected { background: #4CAF50; color: white; border-color: #45a049; }
        
        /* Map nodes dengan animasi */
        .map-node { 
            position: absolute; width: 70px; height: 70px; 
            background: white; border-radius: 50%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.25); 
            transition: all 0.3s; z-index: 10; 
            transform: translate(-50%, -50%); border: 4px solid #ddd;
        }
        .map-node:hover { 
            transform: translate(-50%, -50%) scale(1.15); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.35);
        }
        .map-node.current { 
            border-color: #2196F3; background: #E3F2FD;
            animation: currentPulse 2s ease-in-out infinite;
        }
        .map-node.current::before { 
            content: "üìç"; position: absolute; top: -28px; font-size: 1.5rem; 
            animation: bounceMarker 1s infinite;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 5px 20px rgba(33,150,243,0.3); }
            50% { box-shadow: 0 5px 30px rgba(33,150,243,0.6); }
        }
        
        .map-node.target { 
            border-color: #FF9800; background: #FFF3E0; 
            animation: targetPulse 1.5s infinite;
        }
        .map-node.target::before { 
            content: "üéØ"; position: absolute; top: -28px; font-size: 1.5rem;
            animation: targetBounce 0.8s infinite;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        @keyframes targetPulse { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,152,0,0.5); transform: translate(-50%, -50%) scale(1); } 
            50% { box-shadow: 0 0 0 15px rgba(255,152,0,0); transform: translate(-50%, -50%) scale(1.05); } 
        }
        @keyframes targetBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.1); }
        }
        @keyframes bounceMarker { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        
        .map-node.selected, .map-node.in-path { 
            border-color: #4CAF50; background: #C8E6C9;
            box-shadow: 0 0 20px rgba(76,175,80,0.5);
        }
        .node-icon { font-size: 1.8rem; }
        .node-name { font-size: 0.7rem; font-weight: bold; color: #333; text-align: center; margin-top: 2px; }
        
        .path-info { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 15px; text-align: center; }
        .path-info h4 { color: #1a5a2e; margin-bottom: 10px; }
        .path-display { display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .path-node { background: #4CAF50; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; }
        .path-arrow { color: #999; }
        .path-cost { font-size: 1.2rem; color: #FF9800; font-weight: bold; }
        .btn-go { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; margin-top: 10px; }
        .btn-reset { background: #f5f5f5; color: #666; padding: 12px 25px; font-size: 1rem; }

        /* ========== TRADE & RESULT ========== */
        .trade-panel { flex: 1; margin: 0 15px 15px; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .trade-icon { font-size: 4rem; margin-bottom: 15px; }
        .trade-title { font-size: 1.4rem; color: #1a5a2e; margin-bottom: 10px; }
        .trade-desc { color: #666; margin-bottom: 20px; }
        .trade-item { background: #FFF8E1; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .trade-item-icon { font-size: 2.5rem; }
        .trade-item-name { font-size: 1.1rem; font-weight: bold; color: #333; margin: 8px 0 5px; }
        .trade-item-price { font-size: 1.3rem; color: #FF9800; font-weight: bold; }
        .trade-quantity { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .qty-btn { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 1.8rem; cursor: pointer; }
        .qty-btn.minus { background: #ffcdd2; color: #c62828; }
        .qty-btn.plus { background: #c8e6c9; color: #2e7d32; }
        .qty-btn:hover { transform: scale(1.1); }
        .qty-display { font-size: 2.5rem; font-weight: bold; color: #333; min-width: 80px; }
        .trade-total { font-size: 1.2rem; color: #666; margin-bottom: 20px; }
        .trade-total span { color: #1a5a2e; font-weight: bold; font-size: 1.4rem; }
        .result-panel { flex: 1; margin: 0 15px 15px; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .result-icon { font-size: 4rem; margin-bottom: 15px; }
        .result-title { font-size: 1.8rem; margin-bottom: 20px; }
        .result-breakdown { background: #f9f9f9; padding: 20px; border-radius: 20px; margin-bottom: 20px; width: 100%; max-width: 280px; }
        .result-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1rem; border-bottom: 1px dashed #ddd; }
        .result-row:last-child { border-bottom: none; font-weight: bold; font-size: 1.2rem; }
        .result-stars { font-size: 2.5rem; margin-bottom: 20px; }

        /* ========== CUTSCENE FULLSCREEN RPG STYLE ========== */
        .cutscene-fullscreen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 500;
            flex-direction: column; overflow: hidden;
        }
        .cutscene-fullscreen.active { display: flex; animation: fadeIn 0.5s ease; }
        
        /* Background - soft warm gradient */
        .cutscene-bg {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #FFF8E1 0%, #FFECB3 50%, #FFE082 100%);
            transition: background 0.5s ease;
        }
        
        /* Sparkle particles - gold */
        .cutscene-sparkles {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden; z-index: 1;
        }
        .sparkle {
            position: absolute; width: 6px; height: 6px; background: rgba(255,193,7,0.6); border-radius: 50%;
            animation: sparkleFloat 3s ease-in-out infinite;
        }
        @keyframes sparkleFloat {
            0%, 100% { opacity: 0.3; transform: translateY(0) scale(0.8); }
            50% { opacity: 0.9; transform: translateY(-25px) scale(1.2); }
        }
        
        /* Character container - FULL HEIGHT, karakter sangat besar */
        .cutscene-scene {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; justify-content: center; align-items: flex-end;
            z-index: 2; padding-bottom: 120px; /* ruang untuk dialog box */
        }
        
        .cutscene-character {
            text-align: center; animation: characterEnter 0.6s ease-out;
        }
        @keyframes characterEnter {
            from { transform: scale(0.8) translateY(30px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        /* Character sprite - SANGAT BESAR untuk asset 1000x1000 */
        .cutscene-sprite {
            display: flex; align-items: flex-end; justify-content: center;
            filter: drop-shadow(0 15px 40px rgba(0,0,0,0.2));
            animation: characterFloat 4s ease-in-out infinite;
        }
        .cutscene-sprite .character-img {
            width: auto;
            height: 70vh;
            max-height: 650px;
            object-fit: contain;
        }
        @keyframes characterFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        /* Dialog Box - FIXED di bawah, menimpa karakter */
        .cutscene-dialog {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 10;
            background: rgba(255,255,255,0.97);
            border-top: 5px solid #C9A227;
            padding: 25px 30px 30px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        }
        
        .cutscene-dialog-content {
            max-width: 900px; margin: 0 auto;
        }
        
        /* Speaker name tag */
        .cutscene-speaker {
            display: inline-block;
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            color: white; font-weight: bold; font-size: 1rem;
            padding: 8px 25px; border-radius: 25px;
            margin-bottom: 15px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        }
        
        /* Dialog text */
        .cutscene-text {
            color: #333333; font-size: 1.15rem; line-height: 1.9;
            min-height: 50px;
        }
        .typing-cursor {
            display: inline-block; width: 3px; height: 1.15em;
            background: #2E7D32; margin-left: 2px;
            animation: cursorBlink 0.8s infinite;
            vertical-align: text-bottom;
        }
        @keyframes cursorBlink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        
        /* Controls */
        .cutscene-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .cutscene-indicator { display: flex; gap: 8px; flex-wrap: wrap; }
        .cutscene-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: #ccc; transition: all 0.3s;
        }
        .cutscene-dot.active { background: #2E7D32; transform: scale(1.2); }
        .cutscene-dot.done { background: #81C784; }
        
        .cutscene-buttons { display: flex; gap: 15px; align-items: center; }
        .cutscene-btn {
            padding: 12px 30px; border: none; border-radius: 25px;
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s;
        }
        .cutscene-btn-skip {
            background: transparent; color: rgba(0,0,0,0.4);
        }
        .cutscene-btn-skip:hover { color: rgba(0,0,0,0.7); }
        .cutscene-btn-next {
            background: linear-gradient(135deg, #2E7D32, #1B5E20); color: white;
        }
        .cutscene-btn-next:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(46,125,50,0.4); }
        
        /* Mobile responsive */
        @media (max-width: 600px) {
            .cutscene-sprite .character-img { max-width: 300px; max-height: 70vh; }
            .cutscene-scene { padding-bottom: 140px; }
            .cutscene-text { font-size: 1rem; }
            .cutscene-dialog { padding: 20px; }
        }

        /* ========== CUTSCENE OVERLAY FULLSCREEN ========== */
        .cutscene-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 300; flex-direction: column; overflow: hidden;
        }
        .cutscene-overlay.active { display: flex; animation: fadeIn 0.5s ease; }
        .cutscene-overlay-bg {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2C5F2D 0%, #1E4620 50%, #0D2818 100%);
        }
        .cutscene-overlay-scene {
            flex: 1; position: relative; z-index: 2;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .cutscene-box {
            background: rgba(255,255,255,0.95); border-radius: 30px; padding: 40px;
            max-width: 500px; width: 100%; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .cutscene-icon { font-size: 4.5rem; margin-bottom: 20px; }
        .cutscene-icon.animate-bounce { animation: bounce 1s infinite; }
        .cutscene-title { font-size: 1.8rem; color: #1a5a2e; font-weight: bold; margin-bottom: 15px; }
        .cutscene-text { font-size: 1.15rem; color: #444; line-height: 1.7; margin-bottom: 20px; }
        .cutscene-highlight { background: #f8f8f8; padding: 20px; border-radius: 20px; margin: 20px 0; }
        .cutscene-highlight-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 1.05rem; }
        
        /* Travel Route Display */
        .cutscene-route { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 25px 0; }
        .cutscene-route-node { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .cutscene-route-icon {
            width: 70px; height: 70px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .cutscene-route-icon.start { background: linear-gradient(135deg, #64B5F6, #2196F3); }
        .cutscene-route-icon.end { background: linear-gradient(135deg, #81C784, #4CAF50); }
        .cutscene-route-name { font-size: 1rem; color: #333; font-weight: 600; }
        .cutscene-route-arrow { font-size: 2rem; color: #1a5a2e; }
        
        /* ========== JOURNEY ANIMATION FULLSCREEN ========== */
        .journey-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 400; overflow: hidden;
        }
        .journey-overlay.active { display: block; animation: fadeIn 0.5s ease; }
        
        /* Journey Background - Fullscreen */
        .journey-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/journey-background.png');
            background-size: cover; background-position: center bottom;
            background-repeat: no-repeat;
        }
        
        /* Clouds Container */
        .journey-clouds {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            pointer-events: none; overflow: hidden;
        }
        
        /* Individual Clouds - LEBIH BESAR */
        .journey-cloud {
            position: absolute; opacity: 0.95;
            animation: cloudFloat linear infinite;
        }
        .journey-cloud img { height: 100%; width: auto; }
        
        .journey-cloud.cloud-1 {
            top: 3%; height: 100px;
            animation-duration: 45s;
        }
        .journey-cloud.cloud-2 {
            top: 12%; height: 140px;
            animation-duration: 35s;
            animation-delay: -12s;
        }
        .journey-cloud.cloud-3 {
            top: 5%; height: 180px;
            animation-duration: 50s;
            animation-delay: -25s;
        }
        .journey-cloud.cloud-4 {
            top: 18%; height: 90px;
            animation-duration: 40s;
            animation-delay: -8s;
        }
        .journey-cloud.cloud-5 {
            top: 8%; height: 120px;
            animation-duration: 48s;
            animation-delay: -18s;
        }
        
        @keyframes cloudFloat {
            0% { left: -20%; }
            100% { left: 110%; }
        }
        
        /* Vehicle on Road - LEBIH BESAR */
        .journey-vehicle {
            position: absolute;
            bottom: 8%;
            width: 180px; height: auto;
            animation: vehicleMove 4s ease-in-out infinite;
            z-index: 10;
        }
        .journey-vehicle img {
            width: 100%; height: auto;
            animation: vehicleBounce 0.35s ease-in-out infinite;
        }
        
        @keyframes vehicleMove {
            0% { left: -15%; }
            100% { left: 105%; }
        }
        
        @keyframes vehicleBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-6px) rotate(-1deg); }
        }
        
        /* Journey Info Box - SIMPLIFIED tanpa icon kota */
        .journey-info {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.97); border-radius: 25px;
            padding: 30px 50px; text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
            z-index: 20; min-width: 320px;
        }
        .journey-title {
            font-size: 1.8rem; color: #1a5a2e; font-weight: bold;
            margin-bottom: 15px; font-style: italic;
        }
        .journey-route {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            margin-bottom: 20px; font-size: 1.2rem; color: #333;
        }
        .journey-route-from, .journey-route-to {
            font-weight: 600;
        }
        .journey-arrow { 
            font-size: 1.5rem; color: #1a5a2e; 
        }
        
        .journey-loading {
            display: flex; justify-content: center; gap: 10px;
        }
        .journey-loading-dot {
            width: 12px; height: 12px; background: #1a5a2e; border-radius: 50%;
            animation: dotPulse 1.2s infinite;
        }
        .journey-loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .journey-loading-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .journey-vehicle { width: 140px; bottom: 6%; }
            .journey-cloud.cloud-1 { height: 70px; }
            .journey-cloud.cloud-2 { height: 100px; }
            .journey-cloud.cloud-3 { height: 130px; }
            .journey-cloud.cloud-4 { height: 60px; }
            .journey-cloud.cloud-5 { height: 85px; }
            .journey-info { padding: 25px 35px; min-width: 280px; }
            .journey-title { font-size: 1.5rem; }
        }
        
        /* Old Travel Road (keep for fallback) */
        .cutscene-travel-road {
            width: 100%; height: 100px; border-radius: 15px; position: relative; overflow: hidden; margin: 20px 0;
            background: linear-gradient(180deg, #87CEEB 0%, #90EE90 40%, #8B7355 75%, #6B5344 100%);
        }
        .cutscene-road-line {
            position: absolute; bottom: 22px; left: 0; right: 0; height: 4px;
            background: repeating-linear-gradient(90deg, #fff 0px, #fff 25px, transparent 25px, transparent 50px);
            animation: roadMove 0.6s linear infinite;
        }
        @keyframes roadMove { from { transform: translateX(0); } to { transform: translateX(-50px); } }
        .cutscene-vehicle {
            position: absolute; bottom: 35px; font-size: 2.8rem;
            animation: carBounce 3s ease-in-out infinite;
        }
        @keyframes carBounce { 
            0%, 100% { left: 15%; transform: translateY(0); }
            25% { transform: translateY(-8px); }
            50% { left: 70%; transform: translateY(0); }
            75% { transform: translateY(-8px); }
        }
        
        /* Loading Dots */
        .cutscene-loading { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .cutscene-dot {
            width: 12px; height: 12px; background: #1a5a2e; border-radius: 50%;
            animation: dotPulse 1.2s infinite;
        }
        .cutscene-dot:nth-child(2) { animation-delay: 0.2s; }
        .cutscene-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dotPulse { 0%, 100% { transform: scale(0.8); opacity: 0.4; } 50% { transform: scale(1.2); opacity: 1; } }
        
        /* Item Display */
        .cutscene-item-display {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            background: #E8F5E9; padding: 20px; border-radius: 20px; margin: 20px 0;
        }
        .cutscene-item-icon { font-size: 3rem; }
        .cutscene-item-info { text-align: left; }
        .cutscene-item-name { font-size: 1.2rem; font-weight: bold; color: #333; }
        .cutscene-item-qty { font-size: 1rem; color: #666; }

        /* ========== MAP ========== */
        @media (max-width: 500px) {
            .title-main { font-size: 1.8rem; } .title-logo { font-size: 4rem; }
            .map-node { width: 55px; height: 55px; } .node-icon { font-size: 1.3rem; } .node-name { font-size: 0.55rem; }
            .mini-lb-items { display: none; }
        }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar" id="top-bar" style="display: none;">
        <div class="mini-profile" onclick="showProfile()">
            <div class="mini-profile-avatar" id="topbar-avatar">üßí</div>
            <div class="mini-profile-info">
                <span class="mini-profile-name" id="topbar-name">Pemain</span>
                <span class="mini-profile-rank" id="topbar-rank">üå± Pemula</span>
            </div>
        </div>
        <div class="mini-leaderboard" onclick="showLeaderboard()">
            <span style="font-size:1.1rem;">üèÜ</span>
            <div class="mini-lb-items" id="mini-lb-items"></div>
        </div>
    </div>

    <!-- TITLE SCREEN -->
    <div id="screen-title" class="screen active title-screen">
        <div class="title-content">
            <h1 class="title-main">JURAGAN JUNIOR</h1>
            <p class="title-sub">Petualangan Dagang Nusantara</p>
            <button class="btn-start" onclick="startGame()">MULAI BERDAGANG</button>
        </div>
    </div>

    <!-- MAIN MENU -->
    <div id="screen-main" class="screen main-screen">
        <div class="main-content">
            <div class="menu-card">
                <h2 style="text-align:center; color:#1a5a2e; margin-bottom:15px;">üó∫Ô∏è Pilih Misi</h2>
                
                <!-- Island Tabs -->
                <div class="island-tabs">
                    <button class="island-tab active" id="tab-jawa" onclick="switchIsland('jawa')">
                        <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/icon-jawa.png" class="island-tab-icon-img" alt="Jawa">
                        <span class="island-tab-name">Jawa</span>
                    </button>
                    <button class="island-tab locked" id="tab-sumatera" onclick="switchIsland('sumatera')">
                        <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/icon-sumatera.png" class="island-tab-icon-img" alt="Sumatera">
                        <span class="island-tab-name">Sumatera</span>
                    </button>
                    <button class="island-tab locked" id="tab-kalimantan" onclick="switchIsland('kalimantan')">
                        <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/icon-kalimantan.png" class="island-tab-icon-img" alt="Kalimantan">
                        <span class="island-tab-name">Kalimantan</span>
                    </button>
                    <button class="island-tab locked" id="tab-sulawesi" onclick="switchIsland('sulawesi')">
                        <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/icon-sulawesi.png" class="island-tab-icon-img" alt="Sulawesi">
                        <span class="island-tab-name">Sulawesi</span>
                    </button>
                    <button class="island-tab locked" id="tab-papua" onclick="switchIsland('papua')">
                        <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/icon-papua.png" class="island-tab-icon-img" alt="Papua">
                        <span class="island-tab-name">Papua</span>
                    </button>
                </div>
                
                <!-- Jawa Content -->
                <div class="island-content active" id="island-jawa">
                    <div class="level-grid" id="level-grid-jawa"></div>
                </div>
                
                <!-- Sumatera Content -->
                <div class="island-content" id="island-sumatera">
                    <div class="level-grid" id="level-grid-sumatera"></div>
                </div>
                
                <!-- Kalimantan Content -->
                <div class="island-content" id="island-kalimantan">
                    <div class="level-grid" id="level-grid-kalimantan"></div>
                </div>
                
                <!-- Sulawesi Content -->
                <div class="island-content" id="island-sulawesi">
                    <div class="level-grid" id="level-grid-sulawesi"></div>
                </div>
                
                <!-- Papua Content -->
                <div class="island-content" id="island-papua">
                    <div class="level-grid" id="level-grid-papua"></div>
                </div>
                
                <button class="btn btn-secondary" onclick="showTitle()" style="width:100%; margin-top:10px;">‚Üê Kembali</button>
            </div>
        </div>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="screen-profile" class="screen profile-screen">
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar">üßí</div>
                <div class="profile-name"><input type="text" id="player-name-input" placeholder="Nama Kamu" maxlength="15" onchange="savePlayerName()"></div>
                <div class="profile-title" id="profile-title-badge">Pedagang Pemula</div>
            </div>
            <div class="rank-badge">
                <div class="rank-badge-icon" id="rank-badge-icon">üå±</div>
                <div class="rank-badge-info">
                    <h4 id="rank-name">Pedagang Pemula</h4>
                    <p id="rank-desc">Baru memulai perjalanan dagang</p>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat"><div class="profile-stat-icon">ü™ô</div><div class="profile-stat-value" id="stat-coins">0</div><div class="profile-stat-label">Total Koin</div></div>
                <div class="profile-stat"><div class="profile-stat-icon">‚úÖ</div><div class="profile-stat-value" id="stat-missions">0</div><div class="profile-stat-label">Misi Selesai</div></div>
                <div class="profile-stat"><div class="profile-stat-icon">‚≠ê</div><div class="profile-stat-value" id="stat-stars">0</div><div class="profile-stat-label">Total Bintang</div></div>
                <div class="profile-stat"><div class="profile-stat-icon">üèÜ</div><div class="profile-stat-value" id="stat-best">0</div><div class="profile-stat-label">Untung Terbaik</div></div>
            </div>
            <button class="btn btn-secondary" onclick="goBack()" style="width:100%;">‚Üê Kembali</button>
        </div>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="screen-leaderboard" class="screen leaderboard-screen">
        <div class="leaderboard-card">
            <h2 class="leaderboard-title">üèÜ Papan Peringkat</h2>
            <div class="leaderboard-list" id="leaderboard-list"></div>
            <button class="btn btn-secondary" onclick="goBack()" style="width:100%; margin-top:15px;">‚Üê Kembali</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="screen game-screen">
        <div class="mission-panel">
            <div class="mission-header">
                <div class="mission-icon" id="mission-icon">ü¶ê</div>
                <div class="mission-info"><h2 id="mission-title">Misi Kerupuk</h2><p id="mission-desc">Beli kerupuk dari pabrik, jual ke pasar!</p></div>
            </div>
            <div class="mission-phase">
                <div class="phase-step active" id="phase-1"><span class="phase-step-icon">üö∂</span>Ke Pabrik</div>
                <div class="phase-step" id="phase-2"><span class="phase-step-icon">üõí</span>Beli</div>
                <div class="phase-step" id="phase-3"><span class="phase-step-icon">üö∂</span>Ke Pasar</div>
                <div class="phase-step" id="phase-4"><span class="phase-step-icon">üí∞</span>Jual</div>
            </div>
        </div>
        <div id="game-content"></div>
    </div>

    <!-- CUTSCENE OVERLAY FULLSCREEN -->
    <div id="cutscene-overlay" class="cutscene-overlay">
        <div class="cutscene-overlay-bg"></div>
        <div class="cutscene-overlay-scene">
            <div class="cutscene-box" id="cutscene-box"></div>
        </div>
    </div>

    <!-- JOURNEY ANIMATION FULLSCREEN -->
    <div id="journey-overlay" class="journey-overlay">
        <!-- Background -->
        <div class="journey-bg"></div>
        
        <!-- Clouds -->
        <div class="journey-clouds">
            <div class="journey-cloud cloud-1">
                <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/cloud-small.png" alt="cloud">
            </div>
            <div class="journey-cloud cloud-2">
                <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/cloud-medium.png" alt="cloud">
            </div>
            <div class="journey-cloud cloud-3">
                <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/cloud-large.png" alt="cloud">
            </div>
            <div class="journey-cloud cloud-4">
                <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/cloud-small.png" alt="cloud">
            </div>
            <div class="journey-cloud cloud-5">
                <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/cloud-medium.png" alt="cloud">
            </div>
        </div>
        
        <!-- Vehicle -->
        <div class="journey-vehicle" id="journey-vehicle">
            <img src="https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/vehicle-truck.png" alt="truck">
        </div>
        
        <!-- Info Box -->
        <div class="journey-info">
            <div class="journey-title">Dalam Perjalanan...</div>
            <div class="journey-route" id="journey-route">
                <!-- Will be filled by JS -->
            </div>
            <div class="journey-loading">
                <div class="journey-loading-dot"></div>
                <div class="journey-loading-dot"></div>
                <div class="journey-loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- CUTSCENE FULLSCREEN RPG STYLE (SIMPLE) -->
    <div id="cutscene-fullscreen" class="cutscene-fullscreen">
        <!-- Background -->
        <div class="cutscene-bg" id="cutscene-bg"></div>
        
        <!-- Sparkles -->
        <div class="cutscene-sparkles" id="cutscene-sparkles"></div>
        
        <!-- Scene - Character -->
        <div class="cutscene-scene">
            <div class="cutscene-character">
                <div class="cutscene-sprite" id="cs-sprite">üë©‚Äçüè´</div>
            </div>
        </div>
        
        <!-- Dialog Box -->
        <div class="cutscene-dialog">
            <div class="cutscene-dialog-content">
                <div class="cutscene-speaker" id="cs-speaker">Kak Rina</div>
                <div class="cutscene-text" id="cs-text"></div>
                <div class="cutscene-controls">
                    <div class="cutscene-indicator" id="cs-indicator"></div>
                    <div class="cutscene-buttons">
                        <button class="cutscene-btn cutscene-btn-skip" onclick="skipIntro()">Lewati</button>
                        <button class="cutscene-btn cutscene-btn-next" id="cs-next-btn" onclick="handleIntroClick()">Lanjut ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// ========== ASSET URL ==========
const ASSET_BASE = "https://raw.githubusercontent.com/semar1910/saudagar-cilik-assets-/main/";

// Journey Assets
const journeyAssets = {
    background: ASSET_BASE + "journey-background.png",
    vehicle: ASSET_BASE + "vehicle-truck.png",
    cloudSmall: ASSET_BASE + "cloud-small.png",
    cloudMedium: ASSET_BASE + "cloud-medium.png",
    cloudLarge: ASSET_BASE + "cloud-large.png"
};

const characterImages = {
    // === NPC UTAMA ===
    "Kak Rina": ASSET_BASE + "kak-rina.png",
    "Pak Dedi": ASSET_BASE + "Pak-Dedi.png",
    "Maskot Happy": ASSET_BASE + "maskot-happy.png",
    "Maskot Sad": ASSET_BASE + "maskot-sad.png",
    
    // === NPC JAWA (Produsen) ===
    "Pak Tani": ASSET_BASE + "Pak-Tani.png",        // Petani (bawang, ayam)
    "Bu Dewi": ASSET_BASE + "Bu-Dewi.png",          // Pengrajin (kerupuk, batik, tempe, dodol)
    "Pak Darmo": ASSET_BASE + "Pak-Darmo.png",     // Petani Kebun (teh, kopi, gula)
    "Pak Joko": ASSET_BASE + "Pak-Joko.png",       // Nelayan (ikan)
    
    // === NPC JAWA (Pedagang) ===
    "Bu Siti": ASSET_BASE + "Bu-Siti.png",         // Pedagang Pasar Wanita
    "Pak Wage": ASSET_BASE + "Pak-Wage.png",       // Pedagang Pasar Pria
    "Bu Parti": ASSET_BASE + "Bu-Parti.png",       // Pedagang Pasar Wanita 2
    
    // === NPC SUMATERA (Produsen) ===
    "Pak Ahmad": ASSET_BASE + "Pak-Ahmad.png",     // Petani Kopi Aceh
    "Bu Tiara": ASSET_BASE + "Bu-Tiara.png",       // Penenun Ulos Batak
    "Bu Upik": ASSET_BASE + "Bu-Upik.png",         // Juru Masak Padang
    "Pak Zainal": ASSET_BASE + "Pak-Zainal.png",   // Petani Melayu (durian, sawit, lada)
    
    // === NPC SUMATERA (Pedagang) ===
    "Pak Hasan": ASSET_BASE + "Pak-Hasan.png",     // Pedagang Medan
    "Bu Rina": ASSET_BASE + "Bu-Rina.png",         // Pedagang Padang
    
    // === NPC PULAU LAIN ===
    "Pak Bejo": ASSET_BASE + "Pak-Bejo.png",       // Penambang (Kalimantan)
    "Pak Rustam": ASSET_BASE + "Pak-Rustam.png"    // Pelaut (Sulawesi/Papua)
};

const bgImages = {
    "jawa": ASSET_BASE + "bg-jawa.png",
    "sumatera": ASSET_BASE + "bg-sumatera.png",
    "kalimantan": ASSET_BASE + "bg-kalimantan.png",
    "sulawesi": ASSET_BASE + "bg-sulawesi.png",
    "papua": ASSET_BASE + "bg-papua.png"
};

// ========== INTRO CUTSCENE DATA ==========
const introDialogs = [
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Halo adik-adik! Selamat datang di Saudagar Cilik Nusantara. Hari ini kita akan belajar tentang kegiatan ekonomi sambil bermain, lho!"
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Tahukah kamu? Di Indonesia, setiap hari ada jutaan orang yang melakukan kegiatan ekonomi. Ada yang membuat barang, ada yang menjual, dan ada yang membeli untuk kebutuhan sehari-hari."
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Dalam kegiatan ekonomi, ada tiga peran penting yang saling membutuhkan. Yuk, kita kenalan dengan mereka satu per satu!"
    },
    {
        image: characterImages["Pak Tani"], name: "Pak Tani",
        text: "Halo anak-anak! Namaku Pak Tani. Aku adalah seorang Produsen. Setiap hari aku bekerja keras menanam padi, sayuran, dan buah-buahan untuk dijual ke masyarakat."
    },
    {
        image: characterImages["Pak Tani"], name: "Pak Tani",
        text: "Produsen adalah orang yang membuat atau menghasilkan barang. Selain petani, ada juga pengrajin yang membuat batik, peternak yang memelihara ayam, dan masih banyak lagi."
    },
    {
        image: characterImages["Bu Siti"], name: "Bu Siti",
        text: "Kalau aku Bu Siti, seorang Konsumen. Setiap pagi aku pergi ke pasar untuk membeli beras, sayur, dan lauk untuk keluargaku di rumah."
    },
    {
        image: characterImages["Bu Siti"], name: "Bu Siti",
        text: "Konsumen adalah orang yang membeli dan menggunakan barang untuk memenuhi kebutuhannya. Kamu dan keluargamu juga konsumen, lho! Setiap kali membeli makanan atau baju, kamu sedang menjadi konsumen."
    },
    {
        image: characterImages["Pak Dedi"], name: "Pak Dedi",
        text: "Nah, kalau aku Pak Dedi, seorang Distributor. Tugasku sangat penting, yaitu menjadi penghubung antara Pak Tani dan Bu Siti."
    },
    {
        image: characterImages["Pak Dedi"], name: "Pak Dedi",
        text: "Aku membeli hasil panen dari Pak Tani di desa, lalu membawanya ke pasar di kota agar Bu Siti bisa membelinya. Tanpa distributor, barang dari produsen tidak akan sampai ke tangan konsumen."
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Nah, dalam permainan ini, kamu akan berperan sebagai Distributor seperti Pak Dedi! Kamu akan membeli barang dari pabrik atau petani, lalu menjualnya di pasar."
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Tapi ingat, perjalanan dari pabrik ke pasar membutuhkan ongkos. Semakin jauh jaraknya, semakin mahal ongkosnya. Jadi, kamu harus pandai memilih rute yang paling hemat!"
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Keuntunganmu dihitung dari harga jual dikurangi harga beli dan ongkos perjalanan. Semakin hemat ongkosmu, semakin besar keuntungan yang kamu dapat!"
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Kamu akan berpetualang ke berbagai pulau di Indonesia, mulai dari Jawa, Sumatera, Kalimantan, Sulawesi, hingga Papua. Setiap pulau punya barang dagangan khas yang menarik!"
    },
    {
        image: characterImages["Kak Rina"], name: "Kak Rina",
        text: "Sudah siap menjadi Saudagar Cilik yang sukses? Ayo kita mulai petualangan dagangmu sekarang!"
    }
];

let introState = { 
    currentIndex: 0, 
    isActive: false,
    isTyping: false,
    typingTimeout: null,
    fullText: '',
    currentChar: 0
};

// Typing speed (ms per character)
const TYPING_SPEED = 30;

function showIntro() {
    introState = { 
        currentIndex: 0, 
        isActive: true,
        isTyping: false,
        typingTimeout: null,
        fullText: '',
        currentChar: 0
    };
    document.getElementById('cutscene-fullscreen').classList.add('active');
    createSparkles();
    renderIntroSlide();
    
    // Add keyboard listener
    document.addEventListener('keydown', handleIntroKeydown);
}

function createSparkles() {
    const container = document.getElementById('cutscene-sparkles');
    container.innerHTML = '';
    for (let i = 0; i < 15; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.style.left = Math.random() * 100 + '%';
        sparkle.style.top = Math.random() * 70 + '%';
        sparkle.style.animationDelay = Math.random() * 3 + 's';
        container.appendChild(sparkle);
    }
}

function renderIntroSlide() {
    const slide = introDialogs[introState.currentIndex];
    
    // Update character sprite with image
    const spriteEl = document.getElementById('cs-sprite');
    spriteEl.style.animation = 'none';
    spriteEl.offsetHeight; // Trigger reflow
    spriteEl.style.animation = 'characterEnter 0.6s ease-out, characterFloat 4s ease-in-out 0.6s infinite';
    
    // Use image if available, otherwise use emoji avatar
    if (slide.image) {
        spriteEl.innerHTML = `<img src="${slide.image}" alt="${slide.name}" class="character-img">`;
    } else if (slide.avatar) {
        spriteEl.innerHTML = slide.avatar;
    }
    
    // Update speaker name
    document.getElementById('cs-speaker').textContent = slide.name;
    
    // Start typing effect
    startTyping(slide.text);
    
    // Update indicator
    document.getElementById('cs-indicator').innerHTML = introDialogs.map((_, i) => 
        `<div class="cutscene-dot ${i < introState.currentIndex ? 'done' : i === introState.currentIndex ? 'active' : ''}"></div>`
    ).join('');
    
    // Update button state
    updateNextButton();
}

function startTyping(text) {
    // Clear any existing typing
    if (introState.typingTimeout) {
        clearTimeout(introState.typingTimeout);
    }
    
    introState.fullText = text;
    introState.currentChar = 0;
    introState.isTyping = true;
    
    const textEl = document.getElementById('cs-text');
    textEl.innerHTML = '<span class="typing-cursor"></span>';
    
    typeNextChar();
}

function typeNextChar() {
    if (!introState.isActive) return;
    
    const textEl = document.getElementById('cs-text');
    
    if (introState.currentChar < introState.fullText.length) {
        // Check if we're inside an HTML tag
        let char = introState.fullText[introState.currentChar];
        
        // If we hit a '<', find the closing '>' and add the whole tag
        if (char === '<') {
            const closeIndex = introState.fullText.indexOf('>', introState.currentChar);
            if (closeIndex !== -1) {
                const tag = introState.fullText.substring(introState.currentChar, closeIndex + 1);
                introState.currentChar = closeIndex + 1;
                
                // Remove cursor, add tag, add cursor back
                const currentHTML = textEl.innerHTML.replace('<span class="typing-cursor"></span>', '');
                textEl.innerHTML = currentHTML + tag + '<span class="typing-cursor"></span>';
                
                // Continue immediately for tags
                introState.typingTimeout = setTimeout(typeNextChar, 0);
                return;
            }
        }
        
        // Normal character
        const currentHTML = textEl.innerHTML.replace('<span class="typing-cursor"></span>', '');
        textEl.innerHTML = currentHTML + char + '<span class="typing-cursor"></span>';
        introState.currentChar++;
        
        introState.typingTimeout = setTimeout(typeNextChar, TYPING_SPEED);
    } else {
        // Typing complete
        introState.isTyping = false;
        textEl.innerHTML = introState.fullText; // Remove cursor
        updateNextButton();
    }
}

function skipTyping() {
    if (introState.typingTimeout) {
        clearTimeout(introState.typingTimeout);
    }
    introState.isTyping = false;
    document.getElementById('cs-text').innerHTML = introState.fullText;
    updateNextButton();
}

function updateNextButton() {
    const btn = document.getElementById('cs-next-btn');
    if (introState.currentIndex < introDialogs.length - 1) {
        btn.textContent = 'Lanjut ‚Üí';
    } else {
        btn.textContent = 'Mulai!';
    }
}

function handleIntroClick() {
    if (introState.isTyping) {
        // Skip typing if currently typing
        skipTyping();
    } else {
        // Go to next slide
        nextIntro();
    }
}

function handleIntroKeydown(e) {
    if (!introState.isActive) return;
    
    if (e.key === 'Escape') {
        skipIntro();
    } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        handleIntroClick();
    }
}

function nextIntro() {
    introState.currentIndex++;
    if (introState.currentIndex >= introDialogs.length) {
        closeIntro();
    } else {
        renderIntroSlide();
    }
}

function skipIntro() {
    closeIntro();
}

function closeIntro() {
    if (introState.typingTimeout) {
        clearTimeout(introState.typingTimeout);
    }
    document.removeEventListener('keydown', handleIntroKeydown);
    document.getElementById('cutscene-fullscreen').classList.remove('active');
    introState.isActive = false;
    
    // Lanjut ke menu utama
    loadPlayerData();
    document.getElementById('top-bar').style.display = 'flex';
    updateTopBar();
    updateIslandTabs();
    renderAllLevelGrids();
    switchScreen('screen-main');
}

// ========== DATA ==========
const rankSystem = [
    { name: "Pedagang Pemula", icon: "üå±", minCoins: 0, desc: "Baru memulai perjalanan dagang", avatar: "üßí" },
    { name: "Pedagang Muda", icon: "üåø", minCoins: 100, desc: "Mulai paham seluk-beluk dagang", avatar: "üßë" },
    { name: "Pedagang Cekatan", icon: "üå≥", minCoins: 300, desc: "Sudah mahir mencari untung", avatar: "üßë‚Äçüíº" },
    { name: "Juragan Pasar", icon: "üè™", minCoins: 600, desc: "Menguasai pasar lokal", avatar: "üë®‚Äçüíº" },
    { name: "Saudagar Sukses", icon: "üíº", minCoins: 1000, desc: "Bisnis berkembang pesat", avatar: "ü§µ" },
    { name: "Raja Dagang", icon: "üëë", minCoins: 2000, desc: "Penguasa perdagangan", avatar: "üèÜ" }
];

const fakeLeaderboard = [
    { name: "Raka", coins: 2500 }, { name: "Siti", coins: 1800 }, { name: "Budi", coins: 1200 },
    { name: "Dewi", coins: 900 }, { name: "Andi", coins: 600 }, { name: "Maya", coins: 400 }
];

const npcCharacters = {
    kakakPembimbing: { name: "Kak Rina", avatar: "üë©‚Äçüè´", role: "Pembimbing Muda" },
    pakTani: { name: "Pak Tani", avatar: "üë®‚Äçüåæ", role: "Petani Senior" },
    buPedagang: { name: "Bu Siti", avatar: "üë©‚Äçü¶∞", role: "Pedagang Pasar" },
    pakNelayan: { name: "Pak Joko", avatar: "üßî", role: "Nelayan" },
    buPengrajin: { name: "Bu Dewi", avatar: "üë©‚Äçüé®", role: "Pengrajin" },
    pakKebun: { name: "Pak Darmo", avatar: "üë¥", role: "Petani Kebun" },
    pakTambang: { name: "Pak Bejo", avatar: "üë∑", role: "Penambang" },
    pakLaut: { name: "Pak Rustam", avatar: "üö£", role: "Pelaut" }
};

// NPC Data untuk setiap level (Level 1-20 variatif, 21+ pakai default)
const levelNPCData = {
    // === PULAU JAWA (Level 1-10) ===
    1: { // Kerupuk Cirebon
        producer: { image: "Bu Dewi", name: "Bu Dewi", role: "Pengrajin Kerupuk" },
        merchant: { image: "Bu Siti", name: "Bu Siti", role: "Pedagang Pasar Bandung" }
    },
    2: { // Teh Puncak
        producer: { image: "Pak Darmo", name: "Pak Darmo", role: "Petani Teh" },
        merchant: { image: "Pak Wage", name: "Pak Wage", role: "Pedagang Pasar Jakarta" }
    },
    3: { // Batik Solo
        producer: { image: "Bu Dewi", name: "Bu Dewi", role: "Pengrajin Batik" },
        merchant: { image: "Bu Parti", name: "Bu Parti", role: "Pedagang Pasar Semarang" }
    },
    4: { // Kopi Malang
        producer: { image: "Pak Darmo", name: "Pak Darmo", role: "Petani Kopi" },
        merchant: { image: "Bu Siti", name: "Bu Siti", role: "Pedagang Pasar Surabaya" }
    },
    5: { // Gula Kediri
        producer: { image: "Pak Darmo", name: "Pak Darmo", role: "Petani Tebu" },
        merchant: { image: "Pak Wage", name: "Pak Wage", role: "Pedagang Pasar Madiun" }
    },
    6: { // Tempe Malang
        producer: { image: "Bu Dewi", name: "Bu Dewi", role: "Pengrajin Tempe" },
        merchant: { image: "Bu Parti", name: "Bu Parti", role: "Pedagang Pasar Blitar" }
    },
    7: { // Ikan Tegal
        producer: { image: "Pak Joko", name: "Pak Joko", role: "Nelayan Tegal" },
        merchant: { image: "Bu Siti", name: "Bu Siti", role: "Pedagang Pasar Pekalongan" }
    },
    8: { // Bawang Brebes
        producer: { image: "Pak Tani", name: "Pak Tani", role: "Petani Bawang" },
        merchant: { image: "Pak Wage", name: "Pak Wage", role: "Pedagang Pasar Cirebon" }
    },
    9: { // Ayam Tasik
        producer: { image: "Pak Tani", name: "Pak Tani", role: "Peternak Ayam" },
        merchant: { image: "Bu Parti", name: "Bu Parti", role: "Pedagang Pasar Garut" }
    },
    10: { // Dodol Garut
        producer: { image: "Bu Dewi", name: "Bu Dewi", role: "Pengrajin Dodol" },
        merchant: { image: "Bu Siti", name: "Bu Siti", role: "Pedagang Pasar Bandung" }
    },
    
    // === PULAU SUMATERA (Level 11-20) ===
    11: { // Kopi Gayo
        producer: { image: "Pak Ahmad", name: "Pak Ahmad", role: "Petani Kopi Gayo" },
        merchant: { image: "Pak Hasan", name: "Pak Hasan", role: "Pedagang Pasar Medan" }
    },
    12: { // Ulos Batak
        producer: { image: "Bu Tiara", name: "Bu Tiara", role: "Penenun Ulos" },
        merchant: { image: "Bu Rina", name: "Bu Rina", role: "Pedagang Pasar Padang" }
    },
    13: { // Rendang Padang
        producer: { image: "Bu Upik", name: "Bu Upik", role: "Juru Masak Rendang" },
        merchant: { image: "Pak Hasan", name: "Pak Hasan", role: "Pedagang Pasar Medan" }
    },
    14: { // Durian Medan
        producer: { image: "Pak Zainal", name: "Pak Zainal", role: "Petani Durian" },
        merchant: { image: "Bu Rina", name: "Bu Rina", role: "Pedagang Pasar Padang" }
    },
    15: { // Lada Lampung
        producer: { image: "Pak Zainal", name: "Pak Zainal", role: "Petani Lada" },
        merchant: { image: "Pak Hasan", name: "Pak Hasan", role: "Pedagang Pasar Palembang" }
    },
    16: { // Songket Palembang
        producer: { image: "Bu Tiara", name: "Bu Tiara", role: "Penenun Songket" },
        merchant: { image: "Bu Rina", name: "Bu Rina", role: "Pedagang Pasar Jambi" }
    },
    17: { // Ikan Bilih Padang
        producer: { image: "Pak Joko", name: "Pak Joko", role: "Nelayan Danau Singkarak" },
        merchant: { image: "Pak Hasan", name: "Pak Hasan", role: "Pedagang Pasar Bukittinggi" }
    },
    18: { // Gambir Aceh
        producer: { image: "Pak Ahmad", name: "Pak Ahmad", role: "Petani Gambir" },
        merchant: { image: "Bu Rina", name: "Bu Rina", role: "Pedagang Pasar Medan" }
    },
    19: { // Kelapa Sawit Riau
        producer: { image: "Pak Zainal", name: "Pak Zainal", role: "Petani Sawit" },
        merchant: { image: "Pak Hasan", name: "Pak Hasan", role: "Pedagang Pasar Pekanbaru" }
    },
    20: { // Pempek Palembang
        producer: { image: "Bu Upik", name: "Bu Upik", role: "Pengrajin Pempek" },
        merchant: { image: "Bu Rina", name: "Bu Rina", role: "Pedagang Pasar Lampung" }
    }
};

// Fungsi untuk mendapatkan NPC berdasarkan level
function getNPCForLevel(levelId) {
    if (levelNPCData[levelId]) {
        return levelNPCData[levelId];
    }
    // Default NPC untuk level 21+
    return {
        producer: { image: "Pak Tani", name: "Pak Produsen", role: "Produsen" },
        merchant: { image: "Bu Siti", name: "Bu Pedagang", role: "Pedagang Pasar" }
    };
}

// Dialog generator berdasarkan level - FULLSCREEN STYLE
function getDialogsForLevel(level) {
    const item = level.item;
    const factoryName = level.nodes[level.factoryNode].name;
    const marketName = level.nodes[level.marketNode].name;
    const startName = level.nodes[level.startNode].name;
    
    // Dapatkan NPC untuk level ini
    const npc = getNPCForLevel(level.id);
    const producer = npc.producer;
    const merchant = npc.merchant;
    
    return {
        intro: [
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Halo Saudagar Cilik! Kamu sudah siap untuk misi berikutnya? Kali ini kita punya misi yang menarik, yaitu ${level.name}!`
            },
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Di ${factoryName}, ada ${item.icon} ${item.name} yang sangat terkenal dan banyak dicari orang. Barang ini diproduksi oleh para pengrajin dan petani setempat dengan kualitas terbaik.`
            },
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Tugasmu sebagai distributor adalah membeli ${item.name} dari ${factoryName} dengan harga ${item.buyPrice} koin per buah, lalu membawanya ke pasar di ${marketName}.`
            },
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Di pasar ${marketName}, kamu bisa menjual ${item.name} dengan harga ${item.sellPrice} koin per buah. Lumayan kan selisihnya? Itulah keuntunganmu sebagai distributor!`
            },
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Tapi ingat, perjalanan dari ${startName} ke ${factoryName} dan ke ${marketName} membutuhkan ongkos. Kamu harus pandai memilih rute yang paling hemat!`
            },
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Target keuntunganmu di misi ini adalah ${level.targetProfit} koin. Kamu punya modal 500 koin untuk membeli barang dan membayar ongkos perjalanan. Gunakan dengan bijak ya!`
            },
            { 
                image: characterImages["Kak Rina"], 
                name: "Kak Rina",
                text: `Baiklah, sekarang waktunya berangkat! Pilih rute terbaik menuju ${factoryName} untuk membeli ${item.icon} ${item.name}. Semoga berhasil, Saudagar Cilik!`
            }
        ],
        factory: [
            { 
                image: characterImages[producer.image], 
                name: producer.name,
                text: `Selamat datang di ${factoryName}, anak muda! Namaku ${producer.name}, ${producer.role} di sini. Wah, kamu pasti datang untuk membeli ${item.icon} ${item.name} ya?`
            },
            { 
                image: characterImages[producer.image], 
                name: producer.name,
                text: `${item.name} buatanku ini terkenal kualitasnya di seluruh Nusantara lho. Banyak pedagang dari berbagai kota datang ke sini untuk membelinya.`
            },
            { 
                image: characterImages[producer.image], 
                name: producer.name,
                text: `Harga per buahnya ${item.buyPrice} koin. Silakan beli sebanyak yang kamu mau sesuai modalmu. Semakin banyak kamu beli, semakin besar potensi keuntunganmu nanti!`
            }
        ],
        market: [
            { 
                image: characterImages[merchant.image], 
                name: merchant.name,
                text: `Wah, ada Saudagar Cilik datang! Namaku ${merchant.name}, ${merchant.role}. Kamu bawa ${item.icon} ${item.name} dari ${factoryName} ya? Kebetulan sekali, barang itu sedang banyak dicari!`
            },
            { 
                image: characterImages[merchant.image], 
                name: merchant.name,
                text: `${item.name} dari ${factoryName} memang terkenal kualitasnya. Para konsumen di ${marketName} sangat menyukainya. Aku yakin barangmu akan cepat laku!`
            },
            { 
                image: characterImages[merchant.image], 
                name: merchant.name,
                text: `Aku beli semua barangmu dengan harga ${item.sellPrice} koin per buah ya. Terima kasih sudah menjadi distributor yang menghubungkan produsen dengan konsumen!`
            }
        ]
    };
}

const levels = [
    { id:1, name:"Misi Kerupuk", icon:"ü¶ê", desc:"Beli kerupuk dari Cirebon, jual ke Bandung!", item:{name:"Kerupuk Udang",icon:"ü¶ê",buyPrice:15,sellPrice:25}, startNode:"bandung", factoryNode:"cirebon", marketNode:"bandung", targetProfit:30,
      nodes:{ bandung:{name:"Bandung",icon:"üèôÔ∏è",x:15,y:70}, cimahi:{name:"Cimahi",icon:"üèòÔ∏è",x:15,y:30}, subang:{name:"Subang",icon:"üåæ",x:50,y:30}, cirebon:{name:"Cirebon",icon:"üè≠",x:85,y:50} },
      routes:[ {from:"bandung",to:"cimahi",cost:10}, {from:"bandung",to:"subang",cost:25}, {from:"cimahi",to:"subang",cost:15}, {from:"subang",to:"cirebon",cost:20}, {from:"cimahi",to:"cirebon",cost:45} ] },
    { id:2, name:"Misi Teh", icon:"üçµ", desc:"Beli teh dari Puncak, jual ke Jakarta!", item:{name:"Teh Hijau",icon:"üçµ",buyPrice:20,sellPrice:35}, startNode:"jakarta", factoryNode:"puncak", marketNode:"jakarta", targetProfit:40,
      nodes:{ jakarta:{name:"Jakarta",icon:"üèôÔ∏è",x:15,y:25}, bogor:{name:"Bogor",icon:"üåßÔ∏è",x:50,y:45}, puncak:{name:"Puncak",icon:"üçµ",x:85,y:70}, depok:{name:"Depok",icon:"üèòÔ∏è",x:35,y:70} },
      routes:[ {from:"jakarta",to:"depok",cost:12}, {from:"jakarta",to:"bogor",cost:30}, {from:"depok",to:"bogor",cost:15}, {from:"bogor",to:"puncak",cost:18}, {from:"depok",to:"puncak",cost:40} ] },
    { id:3, name:"Misi Batik", icon:"üëî", desc:"Beli batik dari Solo, jual ke Semarang!", item:{name:"Batik Solo",icon:"üëî",buyPrice:50,sellPrice:80}, startNode:"semarang", factoryNode:"solo", marketNode:"semarang", targetProfit:50,
      nodes:{ semarang:{name:"Semarang",icon:"üèôÔ∏è",x:15,y:30}, salatiga:{name:"Salatiga",icon:"‚õ∞Ô∏è",x:40,y:55}, boyolali:{name:"Boyolali",icon:"üêÑ",x:65,y:30}, solo:{name:"Solo",icon:"üëî",x:85,y:65} },
      routes:[ {from:"semarang",to:"salatiga",cost:20}, {from:"semarang",to:"boyolali",cost:35}, {from:"salatiga",to:"solo",cost:25}, {from:"salatiga",to:"boyolali",cost:15}, {from:"boyolali",to:"solo",cost:18} ] },
    { id:4, name:"Misi Kopi", icon:"‚òï", desc:"Beli kopi dari Malang, jual ke Surabaya!", item:{name:"Kopi Malang",icon:"‚òï",buyPrice:25,sellPrice:45}, startNode:"surabaya", factoryNode:"malang", marketNode:"surabaya", targetProfit:45,
      nodes:{ surabaya:{name:"Surabaya",icon:"üèôÔ∏è",x:85,y:25}, sidoarjo:{name:"Sidoarjo",icon:"ü¶ê",x:70,y:50}, pasuruan:{name:"Pasuruan",icon:"üåä",x:45,y:30}, malang:{name:"Malang",icon:"‚òï",x:20,y:55} },
      routes:[ {from:"surabaya",to:"sidoarjo",cost:10}, {from:"surabaya",to:"pasuruan",cost:30}, {from:"sidoarjo",to:"pasuruan",cost:18}, {from:"pasuruan",to:"malang",cost:22}, {from:"sidoarjo",to:"malang",cost:45} ] },
    { id:5, name:"Misi Gula", icon:"üç¨", desc:"Beli gula dari Kediri, jual ke Madiun!", item:{name:"Gula Tebu",icon:"üç¨",buyPrice:18,sellPrice:30}, startNode:"madiun", factoryNode:"kediri", marketNode:"madiun", targetProfit:35,
      nodes:{ madiun:{name:"Madiun",icon:"üèôÔ∏è",x:15,y:35}, nganjuk:{name:"Nganjuk",icon:"üåæ",x:45,y:25}, kediri:{name:"Kediri",icon:"üè≠",x:75,y:50}, blitar:{name:"Blitar",icon:"üèõÔ∏è",x:85,y:25} },
      routes:[ {from:"madiun",to:"nganjuk",cost:22}, {from:"nganjuk",to:"kediri",cost:18}, {from:"nganjuk",to:"blitar",cost:30}, {from:"kediri",to:"blitar",cost:15} ] },
    { id:6, name:"Misi Tempe", icon:"ü´ò", desc:"Beli tempe dari Malang, jual ke Blitar!", item:{name:"Tempe",icon:"ü´ò",buyPrice:10,sellPrice:18}, startNode:"blitar", factoryNode:"malang", marketNode:"blitar", targetProfit:25,
      nodes:{ blitar:{name:"Blitar",icon:"üèõÔ∏è",x:15,y:50}, kediri:{name:"Kediri",icon:"üè≠",x:40,y:25}, malang:{name:"Malang",icon:"‚òï",x:85,y:50}, batu:{name:"Batu",icon:"üçé",x:60,y:70} },
      routes:[ {from:"blitar",to:"kediri",cost:20}, {from:"kediri",to:"malang",cost:35}, {from:"kediri",to:"batu",cost:28}, {from:"batu",to:"malang",cost:12} ] },
    { id:7, name:"Misi Ikan", icon:"üêü", desc:"Beli ikan dari Tegal, jual ke Pekalongan!", item:{name:"Ikan Segar",icon:"üêü",buyPrice:22,sellPrice:40}, startNode:"pekalongan", factoryNode:"tegal", marketNode:"pekalongan", targetProfit:40,
      nodes:{ pekalongan:{name:"Pekalongan",icon:"üëî",x:15,y:40}, pemalang:{name:"Pemalang",icon:"üåæ",x:45,y:25}, tegal:{name:"Tegal",icon:"‚öì",x:85,y:40}, brebes:{name:"Brebes",icon:"üßÖ",x:60,y:70} },
      routes:[ {from:"pekalongan",to:"pemalang",cost:18}, {from:"pemalang",to:"tegal",cost:22}, {from:"pemalang",to:"brebes",cost:25}, {from:"tegal",to:"brebes",cost:15} ] },
    { id:8, name:"Misi Bawang", icon:"üßÖ", desc:"Beli bawang dari Brebes, jual ke Cirebon!", item:{name:"Bawang Merah",icon:"üßÖ",buyPrice:12,sellPrice:22}, startNode:"cirebon", factoryNode:"brebes", marketNode:"cirebon", targetProfit:30,
      nodes:{ cirebon:{name:"Cirebon",icon:"ü¶ê",x:15,y:65}, kuningan:{name:"Kuningan",icon:"‚õ∞Ô∏è",x:40,y:35}, brebes:{name:"Brebes",icon:"üßÖ",x:75,y:35}, tegal:{name:"Tegal",icon:"‚öì",x:85,y:70} },
      routes:[ {from:"cirebon",to:"kuningan",cost:15}, {from:"kuningan",to:"brebes",cost:25}, {from:"cirebon",to:"brebes",cost:45}, {from:"brebes",to:"tegal",cost:12} ] },
    { id:9, name:"Misi Ayam", icon:"üêî", desc:"Beli ayam dari Tasik, jual ke Garut!", item:{name:"Ayam Kampung",icon:"üêî",buyPrice:35,sellPrice:55}, startNode:"garut", factoryNode:"tasik", marketNode:"garut", targetProfit:45,
      nodes:{ garut:{name:"Garut",icon:"üåã",x:15,y:40}, ciamis:{name:"Ciamis",icon:"üåæ",x:50,y:25}, tasik:{name:"Tasik",icon:"üêî",x:85,y:50}, banjar:{name:"Banjar",icon:"üèòÔ∏è",x:45,y:70} },
      routes:[ {from:"garut",to:"ciamis",cost:30}, {from:"garut",to:"banjar",cost:25}, {from:"ciamis",to:"tasik",cost:20}, {from:"banjar",to:"tasik",cost:22}, {from:"banjar",to:"ciamis",cost:18} ] },
    { id:10, name:"Misi Dodol", icon:"üçÆ", desc:"Beli dodol dari Garut, jual ke Bandung!", item:{name:"Dodol Garut",icon:"üçÆ",buyPrice:28,sellPrice:50}, startNode:"bandung", factoryNode:"garut", marketNode:"bandung", targetProfit:50,
      nodes:{ bandung:{name:"Bandung",icon:"üèôÔ∏è",x:15,y:30}, cimahi:{name:"Cimahi",icon:"üèòÔ∏è",x:15,y:70}, garut:{name:"Garut",icon:"üçÆ",x:70,y:65}, sumedang:{name:"Sumedang",icon:"ü•ü",x:50,y:30} },
      routes:[ {from:"bandung",to:"cimahi",cost:10}, {from:"bandung",to:"sumedang",cost:25}, {from:"cimahi",to:"sumedang",cost:20}, {from:"sumedang",to:"garut",cost:22}, {from:"cimahi",to:"garut",cost:50} ] }
];

// LEVEL SUMATERA (11-20)
const levelsSumatera = [
    { id:11, name:"Misi Kopi Gayo", icon:"‚òï", desc:"Beli kopi dari Aceh, jual ke Medan!", item:{name:"Kopi Gayo",icon:"‚òï",buyPrice:30,sellPrice:55}, startNode:"medan", factoryNode:"aceh", marketNode:"medan", targetProfit:50,
      nodes:{ medan:{name:"Medan",icon:"üèôÔ∏è",x:85,y:50}, binjai:{name:"Binjai",icon:"üèòÔ∏è",x:70,y:30}, aceh:{name:"Aceh",icon:"‚òï",x:15,y:40}, langsa:{name:"Langsa",icon:"üåæ",x:45,y:60} },
      routes:[ {from:"medan",to:"binjai",cost:12}, {from:"binjai",to:"langsa",cost:25}, {from:"langsa",to:"aceh",cost:20}, {from:"binjai",to:"aceh",cost:50} ] },
    { id:12, name:"Misi Ulos", icon:"üß£", desc:"Beli ulos dari Samosir, jual ke Medan!", item:{name:"Ulos Batak",icon:"üß£",buyPrice:45,sellPrice:75}, startNode:"medan", factoryNode:"samosir", marketNode:"medan", targetProfit:55,
      nodes:{ medan:{name:"Medan",icon:"üèôÔ∏è",x:85,y:30}, pematang:{name:"P.Siantar",icon:"üèòÔ∏è",x:60,y:50}, samosir:{name:"Samosir",icon:"üß£",x:25,y:60}, parapat:{name:"Parapat",icon:"üåä",x:45,y:35} },
      routes:[ {from:"medan",to:"pematang",cost:18}, {from:"pematang",to:"parapat",cost:15}, {from:"parapat",to:"samosir",cost:20}, {from:"pematang",to:"samosir",cost:40} ] },
    { id:13, name:"Misi Rendang", icon:"ü•ò", desc:"Beli rendang dari Padang, jual ke Bukittinggi!", item:{name:"Rendang",icon:"ü•ò",buyPrice:35,sellPrice:60}, startNode:"bukittinggi", factoryNode:"padang", marketNode:"bukittinggi", targetProfit:45,
      nodes:{ bukittinggi:{name:"Bukittinggi",icon:"üèîÔ∏è",x:85,y:35}, padang:{name:"Padang",icon:"ü•ò",x:15,y:60}, solok:{name:"Solok",icon:"üåæ",x:50,y:50}, payakumbuh:{name:"Payakumbuh",icon:"üèòÔ∏è",x:70,y:65} },
      routes:[ {from:"bukittinggi",to:"payakumbuh",cost:15}, {from:"payakumbuh",to:"solok",cost:22}, {from:"solok",to:"padang",cost:18}, {from:"bukittinggi",to:"solok",cost:35} ] },
    { id:14, name:"Misi Durian", icon:"üçà", desc:"Beli durian dari Palembang, jual ke Jambi!", item:{name:"Durian",icon:"üçà",buyPrice:25,sellPrice:45}, startNode:"jambi", factoryNode:"palembang", marketNode:"jambi", targetProfit:40,
      nodes:{ jambi:{name:"Jambi",icon:"üèôÔ∏è",x:15,y:40}, muarabulian:{name:"M.Bulian",icon:"üèòÔ∏è",x:40,y:30}, palembang:{name:"Palembang",icon:"üçà",x:85,y:55}, sekayu:{name:"Sekayu",icon:"üåæ",x:60,y:65} },
      routes:[ {from:"jambi",to:"muarabulian",cost:20}, {from:"muarabulian",to:"sekayu",cost:25}, {from:"sekayu",to:"palembang",cost:18}, {from:"muarabulian",to:"palembang",cost:45} ] },
    { id:15, name:"Misi Lada", icon:"üå∂Ô∏è", desc:"Beli lada dari Lampung, jual ke Palembang!", item:{name:"Lada Hitam",icon:"üå∂Ô∏è",buyPrice:20,sellPrice:38}, startNode:"palembang", factoryNode:"lampung", marketNode:"palembang", targetProfit:35,
      nodes:{ palembang:{name:"Palembang",icon:"üèôÔ∏è",x:15,y:35}, lahat:{name:"Lahat",icon:"üèîÔ∏è",x:35,y:55}, lampung:{name:"Lampung",icon:"üå∂Ô∏è",x:85,y:65}, baturaja:{name:"Baturaja",icon:"üèòÔ∏è",x:55,y:40} },
      routes:[ {from:"palembang",to:"lahat",cost:22}, {from:"lahat",to:"baturaja",cost:18}, {from:"baturaja",to:"lampung",cost:25}, {from:"lahat",to:"lampung",cost:45} ] },
    { id:16, name:"Misi Gambir", icon:"üçÉ", desc:"Beli gambir dari Payakumbuh, jual ke Padang!", item:{name:"Gambir",icon:"üçÉ",buyPrice:18,sellPrice:32}, startNode:"padang", factoryNode:"payakumbuh", marketNode:"padang", targetProfit:30,
      nodes:{ padang:{name:"Padang",icon:"üèôÔ∏è",x:15,y:50}, solok:{name:"Solok",icon:"üåæ",x:40,y:35}, payakumbuh:{name:"Payakumbuh",icon:"üçÉ",x:85,y:45}, bukittinggi:{name:"Bukittinggi",icon:"üèîÔ∏è",x:60,y:65} },
      routes:[ {from:"padang",to:"solok",cost:18}, {from:"solok",to:"bukittinggi",cost:20}, {from:"bukittinggi",to:"payakumbuh",cost:15}, {from:"solok",to:"payakumbuh",cost:38} ] },
    { id:17, name:"Misi Pinang", icon:"ü•ú", desc:"Beli pinang dari Jambi, jual ke Palembang!", item:{name:"Pinang",icon:"ü•ú",buyPrice:15,sellPrice:28}, startNode:"palembang", factoryNode:"jambi", marketNode:"palembang", targetProfit:30,
      nodes:{ palembang:{name:"Palembang",icon:"üèôÔ∏è",x:85,y:50}, muarabulian:{name:"M.Bulian",icon:"üèòÔ∏è",x:55,y:35}, jambi:{name:"Jambi",icon:"ü•ú",x:15,y:45}, sekayu:{name:"Sekayu",icon:"üåæ",x:70,y:70} },
      routes:[ {from:"palembang",to:"sekayu",cost:15}, {from:"sekayu",to:"muarabulian",cost:22}, {from:"muarabulian",to:"jambi",cost:20}, {from:"palembang",to:"muarabulian",cost:40} ] },
    { id:18, name:"Misi Kelapa", icon:"ü••", desc:"Beli kelapa dari Riau, jual ke Pekanbaru!", item:{name:"Kelapa",icon:"ü••",buyPrice:12,sellPrice:22}, startNode:"pekanbaru", factoryNode:"dumai", marketNode:"pekanbaru", targetProfit:25,
      nodes:{ pekanbaru:{name:"Pekanbaru",icon:"üèôÔ∏è",x:85,y:45}, dumai:{name:"Dumai",icon:"ü••",x:15,y:35}, bengkalis:{name:"Bengkalis",icon:"üèùÔ∏è",x:45,y:55}, siak:{name:"Siak",icon:"üèòÔ∏è",x:60,y:30} },
      routes:[ {from:"pekanbaru",to:"siak",cost:18}, {from:"siak",to:"bengkalis",cost:20}, {from:"bengkalis",to:"dumai",cost:15}, {from:"siak",to:"dumai",cost:38} ] },
    { id:19, name:"Misi Karet", icon:"‚ö´", desc:"Beli karet dari Jambi, jual ke Medan!", item:{name:"Karet",icon:"‚ö´",buyPrice:22,sellPrice:40}, startNode:"medan", factoryNode:"jambi", marketNode:"medan", targetProfit:40,
      nodes:{ medan:{name:"Medan",icon:"üèôÔ∏è",x:15,y:30}, pekanbaru:{name:"Pekanbaru",icon:"üèòÔ∏è",x:45,y:45}, jambi:{name:"Jambi",icon:"‚ö´",x:85,y:60}, dumai:{name:"Dumai",icon:"üåä",x:30,y:65} },
      routes:[ {from:"medan",to:"dumai",cost:28}, {from:"dumai",to:"pekanbaru",cost:20}, {from:"pekanbaru",to:"jambi",cost:25}, {from:"dumai",to:"jambi",cost:50} ] },
    { id:20, name:"Misi Pempek", icon:"üç•", desc:"Beli pempek dari Palembang, jual ke Lampung!", item:{name:"Pempek",icon:"üç•",buyPrice:18,sellPrice:35}, startNode:"lampung", factoryNode:"palembang", marketNode:"lampung", targetProfit:35,
      nodes:{ lampung:{name:"Lampung",icon:"üèôÔ∏è",x:85,y:60}, baturaja:{name:"Baturaja",icon:"üèòÔ∏è",x:55,y:40}, palembang:{name:"Palembang",icon:"üç•",x:15,y:35}, lahat:{name:"Lahat",icon:"üèîÔ∏è",x:35,y:65} },
      routes:[ {from:"lampung",to:"baturaja",cost:22}, {from:"baturaja",to:"lahat",cost:18}, {from:"lahat",to:"palembang",cost:20}, {from:"baturaja",to:"palembang",cost:42} ] }
];

// LEVEL KALIMANTAN (21-30)
const levelsKalimantan = [
    { id:21, name:"Misi Sarang Burung", icon:"ü™π", desc:"Beli sarang burung dari Pontianak, jual ke Singkawang!", item:{name:"Sarang Burung",icon:"ü™π",buyPrice:80,sellPrice:130}, startNode:"singkawang", factoryNode:"pontianak", marketNode:"singkawang", targetProfit:80,
      nodes:{ singkawang:{name:"Singkawang",icon:"üèôÔ∏è",x:15,y:35}, sambas:{name:"Sambas",icon:"üèòÔ∏è",x:30,y:60}, pontianak:{name:"Pontianak",icon:"ü™π",x:85,y:50}, mempawah:{name:"Mempawah",icon:"üåä",x:55,y:35} },
      routes:[ {from:"singkawang",to:"sambas",cost:20}, {from:"sambas",to:"mempawah",cost:25}, {from:"mempawah",to:"pontianak",cost:18}, {from:"singkawang",to:"mempawah",cost:40} ] },
    { id:22, name:"Misi Karet Kalbar", icon:"‚ö´", desc:"Beli karet dari Sanggau, jual ke Pontianak!", item:{name:"Karet",icon:"‚ö´",buyPrice:25,sellPrice:45}, startNode:"pontianak", factoryNode:"sanggau", marketNode:"pontianak", targetProfit:45,
      nodes:{ pontianak:{name:"Pontianak",icon:"üèôÔ∏è",x:15,y:45}, ngabang:{name:"Ngabang",icon:"üèòÔ∏è",x:40,y:30}, sanggau:{name:"Sanggau",icon:"‚ö´",x:85,y:50}, sekadau:{name:"Sekadau",icon:"üåæ",x:60,y:70} },
      routes:[ {from:"pontianak",to:"ngabang",cost:22}, {from:"ngabang",to:"sekadau",cost:20}, {from:"sekadau",to:"sanggau",cost:18}, {from:"ngabang",to:"sanggau",cost:42} ] },
    { id:23, name:"Misi Durian Kaltim", icon:"üçà", desc:"Beli durian dari Samarinda, jual ke Balikpapan!", item:{name:"Durian",icon:"üçà",buyPrice:28,sellPrice:50}, startNode:"balikpapan", factoryNode:"samarinda", marketNode:"balikpapan", targetProfit:45,
      nodes:{ balikpapan:{name:"Balikpapan",icon:"üèôÔ∏è",x:85,y:55}, tenggarong:{name:"Tenggarong",icon:"üèòÔ∏è",x:55,y:35}, samarinda:{name:"Samarinda",icon:"üçà",x:15,y:40}, bontang:{name:"Bontang",icon:"üè≠",x:35,y:70} },
      routes:[ {from:"balikpapan",to:"tenggarong",cost:25}, {from:"tenggarong",to:"bontang",cost:22}, {from:"bontang",to:"samarinda",cost:18}, {from:"tenggarong",to:"samarinda",cost:40} ] },
    { id:24, name:"Misi Rotan", icon:"ü™µ", desc:"Beli rotan dari Banjarmasin, jual ke Palangkaraya!", item:{name:"Rotan",icon:"ü™µ",buyPrice:20,sellPrice:38}, startNode:"palangkaraya", factoryNode:"banjarmasin", marketNode:"palangkaraya", targetProfit:35,
      nodes:{ palangkaraya:{name:"Palangkaraya",icon:"üèôÔ∏è",x:15,y:40}, kualakapuas:{name:"K.Kapuas",icon:"üèòÔ∏è",x:40,y:55}, banjarmasin:{name:"Banjarmasin",icon:"ü™µ",x:85,y:50}, banjarbaru:{name:"Banjarbaru",icon:"üåæ",x:65,y:30} },
      routes:[ {from:"palangkaraya",to:"kualakapuas",cost:22}, {from:"kualakapuas",to:"banjarbaru",cost:25}, {from:"banjarbaru",to:"banjarmasin",cost:15}, {from:"kualakapuas",to:"banjarmasin",cost:40} ] },
    { id:25, name:"Misi Intan", icon:"üíé", desc:"Beli intan dari Martapura, jual ke Banjarmasin!", item:{name:"Intan",icon:"üíé",buyPrice:100,sellPrice:160}, startNode:"banjarmasin", factoryNode:"martapura", marketNode:"banjarmasin", targetProfit:90,
      nodes:{ banjarmasin:{name:"Banjarmasin",icon:"üèôÔ∏è",x:15,y:50}, banjarbaru:{name:"Banjarbaru",icon:"üèòÔ∏è",x:45,y:35}, martapura:{name:"Martapura",icon:"üíé",x:85,y:45}, rantau:{name:"Rantau",icon:"üåæ",x:55,y:70} },
      routes:[ {from:"banjarmasin",to:"banjarbaru",cost:15}, {from:"banjarbaru",to:"rantau",cost:22}, {from:"rantau",to:"martapura",cost:20}, {from:"banjarbaru",to:"martapura",cost:38} ] },
    { id:26, name:"Misi Sawit", icon:"üå¥", desc:"Beli sawit dari Sampit, jual ke Palangkaraya!", item:{name:"Sawit",icon:"üå¥",buyPrice:15,sellPrice:28}, startNode:"palangkaraya", factoryNode:"sampit", marketNode:"palangkaraya", targetProfit:30,
      nodes:{ palangkaraya:{name:"Palangkaraya",icon:"üèôÔ∏è",x:15,y:45}, kasongan:{name:"Kasongan",icon:"üèòÔ∏è",x:40,y:30}, sampit:{name:"Sampit",icon:"üå¥",x:85,y:50}, pangkalanbun:{name:"P.Bun",icon:"üåä",x:55,y:70} },
      routes:[ {from:"palangkaraya",to:"kasongan",cost:18}, {from:"kasongan",to:"pangkalanbun",cost:25}, {from:"pangkalanbun",to:"sampit",cost:22}, {from:"kasongan",to:"sampit",cost:42} ] },
    { id:27, name:"Misi Ikan Kaltara", icon:"üêü", desc:"Beli ikan dari Tarakan, jual ke Tanjung Selor!", item:{name:"Ikan Laut",icon:"üêü",buyPrice:22,sellPrice:42}, startNode:"tanjungselor", factoryNode:"tarakan", marketNode:"tanjungselor", targetProfit:40,
      nodes:{ tanjungselor:{name:"Tj.Selor",icon:"üèôÔ∏è",x:85,y:45}, malinau:{name:"Malinau",icon:"üèòÔ∏è",x:55,y:30}, tarakan:{name:"Tarakan",icon:"üêü",x:15,y:50}, nunukan:{name:"Nunukan",icon:"üèùÔ∏è",x:35,y:70} },
      routes:[ {from:"tanjungselor",to:"malinau",cost:20}, {from:"malinau",to:"nunukan",cost:25}, {from:"nunukan",to:"tarakan",cost:18}, {from:"malinau",to:"tarakan",cost:45} ] },
    { id:28, name:"Misi Kayu", icon:"ü™ì", desc:"Beli kayu dari Sintang, jual ke Pontianak!", item:{name:"Kayu Ulin",icon:"ü™ì",buyPrice:35,sellPrice:60}, startNode:"pontianak", factoryNode:"sintang", marketNode:"pontianak", targetProfit:50,
      nodes:{ pontianak:{name:"Pontianak",icon:"üèôÔ∏è",x:15,y:40}, sanggau:{name:"Sanggau",icon:"üèòÔ∏è",x:40,y:55}, sintang:{name:"Sintang",icon:"ü™ì",x:85,y:50}, sekadau:{name:"Sekadau",icon:"üåæ",x:60,y:30} },
      routes:[ {from:"pontianak",to:"sanggau",cost:28}, {from:"sanggau",to:"sekadau",cost:20}, {from:"sekadau",to:"sintang",cost:22}, {from:"sanggau",to:"sintang",cost:45} ] },
    { id:29, name:"Misi Udang", icon:"ü¶ê", desc:"Beli udang dari Kotabaru, jual ke Banjarmasin!", item:{name:"Udang",icon:"ü¶ê",buyPrice:30,sellPrice:52}, startNode:"banjarmasin", factoryNode:"kotabaru", marketNode:"banjarmasin", targetProfit:45,
      nodes:{ banjarmasin:{name:"Banjarmasin",icon:"üèôÔ∏è",x:15,y:40}, batulicin:{name:"Batulicin",icon:"üèòÔ∏è",x:50,y:55}, kotabaru:{name:"Kotabaru",icon:"ü¶ê",x:85,y:45}, tanah_grogot:{name:"T.Grogot",icon:"üåä",x:65,y:25} },
      routes:[ {from:"banjarmasin",to:"batulicin",cost:28}, {from:"batulicin",to:"tanah_grogot",cost:22}, {from:"tanah_grogot",to:"kotabaru",cost:20}, {from:"batulicin",to:"kotabaru",cost:42} ] },
    { id:30, name:"Misi Tengkawang", icon:"üå∞", desc:"Beli tengkawang dari Putussibau, jual ke Pontianak!", item:{name:"Tengkawang",icon:"üå∞",buyPrice:40,sellPrice:70}, startNode:"pontianak", factoryNode:"putussibau", marketNode:"pontianak", targetProfit:55,
      nodes:{ pontianak:{name:"Pontianak",icon:"üèôÔ∏è",x:15,y:45}, sintang:{name:"Sintang",icon:"üèòÔ∏è",x:45,y:35}, putussibau:{name:"Putussibau",icon:"üå∞",x:85,y:50}, nangapinoh:{name:"N.Pinoh",icon:"üåæ",x:60,y:70} },
      routes:[ {from:"pontianak",to:"sintang",cost:35}, {from:"sintang",to:"nangapinoh",cost:22}, {from:"nangapinoh",to:"putussibau",cost:25}, {from:"sintang",to:"putussibau",cost:48} ] }
];

// LEVEL SULAWESI (31-40)
const levelsSulawesi = [
    { id:31, name:"Misi Sutra", icon:"üßµ", desc:"Beli sutra dari Sengkang, jual ke Makassar!", item:{name:"Sutra Bugis",icon:"üßµ",buyPrice:60,sellPrice:100}, startNode:"makassar", factoryNode:"sengkang", marketNode:"makassar", targetProfit:70,
      nodes:{ makassar:{name:"Makassar",icon:"üèôÔ∏è",x:15,y:55}, maros:{name:"Maros",icon:"üèòÔ∏è",x:30,y:35}, sengkang:{name:"Sengkang",icon:"üßµ",x:85,y:45}, bone:{name:"Bone",icon:"üåæ",x:60,y:70} },
      routes:[ {from:"makassar",to:"maros",cost:15}, {from:"maros",to:"bone",cost:28}, {from:"bone",to:"sengkang",cost:20}, {from:"maros",to:"sengkang",cost:50} ] },
    { id:32, name:"Misi Cengkeh", icon:"üåø", desc:"Beli cengkeh dari Manado, jual ke Gorontalo!", item:{name:"Cengkeh",icon:"üåø",buyPrice:35,sellPrice:60}, startNode:"gorontalo", factoryNode:"manado", marketNode:"gorontalo", targetProfit:50,
      nodes:{ gorontalo:{name:"Gorontalo",icon:"üèôÔ∏è",x:15,y:45}, kotamobagu:{name:"Kotamobagu",icon:"üèòÔ∏è",x:45,y:30}, manado:{name:"Manado",icon:"üåø",x:85,y:40}, tomohon:{name:"Tomohon",icon:"‚õ∞Ô∏è",x:70,y:65} },
      routes:[ {from:"gorontalo",to:"kotamobagu",cost:25}, {from:"kotamobagu",to:"tomohon",cost:22}, {from:"tomohon",to:"manado",cost:15}, {from:"kotamobagu",to:"manado",cost:40} ] },
    { id:33, name:"Misi Cakalang", icon:"üêü", desc:"Beli cakalang dari Ternate, jual ke Manado!", item:{name:"Cakalang Fufu",icon:"üêü",buyPrice:28,sellPrice:50}, startNode:"manado", factoryNode:"ternate", marketNode:"manado", targetProfit:45,
      nodes:{ manado:{name:"Manado",icon:"üèôÔ∏è",x:15,y:40}, bitung:{name:"Bitung",icon:"üèòÔ∏è",x:35,y:60}, ternate:{name:"Ternate",icon:"üêü",x:85,y:50}, tahuna:{name:"Tahuna",icon:"üèùÔ∏è",x:55,y:25} },
      routes:[ {from:"manado",to:"bitung",cost:18}, {from:"bitung",to:"tahuna",cost:30}, {from:"tahuna",to:"ternate",cost:25}, {from:"bitung",to:"ternate",cost:48} ] },
    { id:34, name:"Misi Kopra", icon:"ü••", desc:"Beli kopra dari Palu, jual ke Makassar!", item:{name:"Kopra",icon:"ü••",buyPrice:18,sellPrice:32}, startNode:"makassar", factoryNode:"palu", marketNode:"makassar", targetProfit:35,
      nodes:{ makassar:{name:"Makassar",icon:"üèôÔ∏è",x:15,y:60}, pare:{name:"Pare-Pare",icon:"üèòÔ∏è",x:35,y:40}, palu:{name:"Palu",icon:"ü••",x:85,y:35}, mamuju:{name:"Mamuju",icon:"üåæ",x:55,y:65} },
      routes:[ {from:"makassar",to:"pare",cost:22}, {from:"pare",to:"mamuju",cost:25}, {from:"mamuju",to:"palu",cost:28}, {from:"pare",to:"palu",cost:50} ] },
    { id:35, name:"Misi Cokelat", icon:"üç´", desc:"Beli cokelat dari Nosu, jual ke Palu!", item:{name:"Cokelat",icon:"üç´",buyPrice:25,sellPrice:45}, startNode:"palu", factoryNode:"nosu", marketNode:"palu", targetProfit:40,
      nodes:{ palu:{name:"Palu",icon:"üèôÔ∏è",x:15,y:45}, poso:{name:"Poso",icon:"üèòÔ∏è",x:45,y:30}, nosu:{name:"Nosu",icon:"üç´",x:85,y:50}, tentena:{name:"Tentena",icon:"üåä",x:60,y:70} },
      routes:[ {from:"palu",to:"poso",cost:28}, {from:"poso",to:"tentena",cost:18}, {from:"tentena",to:"nosu",cost:22}, {from:"poso",to:"nosu",cost:45} ] },
    { id:36, name:"Misi Kemiri", icon:"üå∞", desc:"Beli kemiri dari Enrekang, jual ke Makassar!", item:{name:"Kemiri",icon:"üå∞",buyPrice:15,sellPrice:28}, startNode:"makassar", factoryNode:"enrekang", marketNode:"makassar", targetProfit:30,
      nodes:{ makassar:{name:"Makassar",icon:"üèôÔ∏è",x:15,y:55}, pare:{name:"Pare-Pare",icon:"üèòÔ∏è",x:40,y:35}, enrekang:{name:"Enrekang",icon:"üå∞",x:85,y:45}, pinrang:{name:"Pinrang",icon:"üåæ",x:60,y:70} },
      routes:[ {from:"makassar",to:"pare",cost:22}, {from:"pare",to:"pinrang",cost:18}, {from:"pinrang",to:"enrekang",cost:20}, {from:"pare",to:"enrekang",cost:42} ] },
    { id:37, name:"Misi Vanili", icon:"üå±", desc:"Beli vanili dari Toli-Toli, jual ke Palu!", item:{name:"Vanili",icon:"üå±",buyPrice:50,sellPrice:85}, startNode:"palu", factoryNode:"tolitoli", marketNode:"palu", targetProfit:60,
      nodes:{ palu:{name:"Palu",icon:"üèôÔ∏è",x:85,y:50}, donggala:{name:"Donggala",icon:"üèòÔ∏è",x:65,y:30}, tolitoli:{name:"Toli-Toli",icon:"üå±",x:15,y:40}, buol:{name:"Buol",icon:"üåæ",x:40,y:65} },
      routes:[ {from:"palu",to:"donggala",cost:18}, {from:"donggala",to:"buol",cost:28}, {from:"buol",to:"tolitoli",cost:22}, {from:"donggala",to:"tolitoli",cost:52} ] },
    { id:38, name:"Misi Rumput Laut", icon:"üåø", desc:"Beli rumput laut dari Wakatobi, jual ke Kendari!", item:{name:"Rumput Laut",icon:"üåø",buyPrice:12,sellPrice:24}, startNode:"kendari", factoryNode:"wakatobi", marketNode:"kendari", targetProfit:28,
      nodes:{ kendari:{name:"Kendari",icon:"üèôÔ∏è",x:15,y:45}, baubau:{name:"Bau-Bau",icon:"üèòÔ∏è",x:45,y:60}, wakatobi:{name:"Wakatobi",icon:"üåø",x:85,y:50}, kolaka:{name:"Kolaka",icon:"üåæ",x:35,y:30} },
      routes:[ {from:"kendari",to:"kolaka",cost:20}, {from:"kolaka",to:"baubau",cost:28}, {from:"baubau",to:"wakatobi",cost:22}, {from:"kendari",to:"baubau",cost:45} ] },
    { id:39, name:"Misi Markisa", icon:"üçá", desc:"Beli markisa dari Toraja, jual ke Makassar!", item:{name:"Markisa",icon:"üçá",buyPrice:20,sellPrice:38}, startNode:"makassar", factoryNode:"toraja", marketNode:"makassar", targetProfit:38,
      nodes:{ makassar:{name:"Makassar",icon:"üèôÔ∏è",x:15,y:60}, pare:{name:"Pare-Pare",icon:"üèòÔ∏è",x:35,y:40}, toraja:{name:"Toraja",icon:"üçá",x:85,y:35}, palopo:{name:"Palopo",icon:"üèòÔ∏è",x:60,y:65} },
      routes:[ {from:"makassar",to:"pare",cost:22}, {from:"pare",to:"palopo",cost:25}, {from:"palopo",to:"toraja",cost:18}, {from:"pare",to:"toraja",cost:48} ] },
    { id:40, name:"Misi Kepiting", icon:"ü¶Ä", desc:"Beli kepiting dari Kendari, jual ke Makassar!", item:{name:"Kepiting",icon:"ü¶Ä",buyPrice:35,sellPrice:62}, startNode:"makassar", factoryNode:"kendari", marketNode:"makassar", targetProfit:50,
      nodes:{ makassar:{name:"Makassar",icon:"üèôÔ∏è",x:15,y:50}, bone:{name:"Bone",icon:"üèòÔ∏è",x:40,y:35}, kendari:{name:"Kendari",icon:"ü¶Ä",x:85,y:45}, kolaka:{name:"Kolaka",icon:"üåæ",x:60,y:70} },
      routes:[ {from:"makassar",to:"bone",cost:25}, {from:"bone",to:"kolaka",cost:30}, {from:"kolaka",to:"kendari",cost:22}, {from:"bone",to:"kendari",cost:55} ] }
];

// LEVEL PAPUA (41-50)
const levelsPapua = [
    { id:41, name:"Misi Sagu", icon:"üå¥", desc:"Beli sagu dari Merauke, jual ke Jayapura!", item:{name:"Sagu",icon:"üå¥",buyPrice:15,sellPrice:30}, startNode:"jayapura", factoryNode:"merauke", marketNode:"jayapura", targetProfit:35,
      nodes:{ jayapura:{name:"Jayapura",icon:"üèôÔ∏è",x:85,y:35}, sentani:{name:"Sentani",icon:"üèòÔ∏è",x:70,y:55}, merauke:{name:"Merauke",icon:"üå¥",x:15,y:60}, timika:{name:"Timika",icon:"üè≠",x:40,y:40} },
      routes:[ {from:"jayapura",to:"sentani",cost:12}, {from:"sentani",to:"timika",cost:35}, {from:"timika",to:"merauke",cost:30}, {from:"sentani",to:"merauke",cost:60} ] },
    { id:42, name:"Misi Pala", icon:"ü´í", desc:"Beli pala dari Fakfak, jual ke Sorong!", item:{name:"Pala",icon:"ü´í",buyPrice:40,sellPrice:70}, startNode:"sorong", factoryNode:"fakfak", marketNode:"sorong", targetProfit:55,
      nodes:{ sorong:{name:"Sorong",icon:"üèôÔ∏è",x:15,y:40}, manokwari:{name:"Manokwari",icon:"üèòÔ∏è",x:45,y:30}, fakfak:{name:"Fakfak",icon:"ü´í",x:85,y:55}, kaimana:{name:"Kaimana",icon:"üåä",x:60,y:70} },
      routes:[ {from:"sorong",to:"manokwari",cost:28}, {from:"manokwari",to:"kaimana",cost:32}, {from:"kaimana",to:"fakfak",cost:22}, {from:"manokwari",to:"fakfak",cost:55} ] },
    { id:43, name:"Misi Mutiara", icon:"ü¶™", desc:"Beli mutiara dari Raja Ampat, jual ke Sorong!", item:{name:"Mutiara",icon:"ü¶™",buyPrice:120,sellPrice:200}, startNode:"sorong", factoryNode:"rajaampat", marketNode:"sorong", targetProfit:100,
      nodes:{ sorong:{name:"Sorong",icon:"üèôÔ∏è",x:85,y:45}, teminabuan:{name:"Teminabuan",icon:"üèòÔ∏è",x:55,y:30}, rajaampat:{name:"Raja Ampat",icon:"ü¶™",x:15,y:40}, waisai:{name:"Waisai",icon:"üèùÔ∏è",x:35,y:65} },
      routes:[ {from:"sorong",to:"teminabuan",cost:25}, {from:"teminabuan",to:"waisai",cost:30}, {from:"waisai",to:"rajaampat",cost:20}, {from:"teminabuan",to:"rajaampat",cost:52} ] },
    { id:44, name:"Misi Kopi Papua", icon:"‚òï", desc:"Beli kopi dari Wamena, jual ke Jayapura!", item:{name:"Kopi Wamena",icon:"‚òï",buyPrice:45,sellPrice:80}, startNode:"jayapura", factoryNode:"wamena", marketNode:"jayapura", targetProfit:60,
      nodes:{ jayapura:{name:"Jayapura",icon:"üèôÔ∏è",x:15,y:40}, sentani:{name:"Sentani",icon:"üèòÔ∏è",x:35,y:60}, wamena:{name:"Wamena",icon:"‚òï",x:85,y:50}, elelim:{name:"Elelim",icon:"‚õ∞Ô∏è",x:60,y:30} },
      routes:[ {from:"jayapura",to:"sentani",cost:12}, {from:"sentani",to:"elelim",cost:35}, {from:"elelim",to:"wamena",cost:28}, {from:"sentani",to:"wamena",cost:58} ] },
    { id:45, name:"Misi Ubi Papua", icon:"üç†", desc:"Beli ubi dari Wamena, jual ke Timika!", item:{name:"Ubi Jalar",icon:"üç†",buyPrice:10,sellPrice:22}, startNode:"timika", factoryNode:"wamena", marketNode:"timika", targetProfit:28,
      nodes:{ timika:{name:"Timika",icon:"üèôÔ∏è",x:15,y:50}, enarotali:{name:"Enarotali",icon:"üèòÔ∏è",x:45,y:35}, wamena:{name:"Wamena",icon:"üç†",x:85,y:45}, mulia:{name:"Mulia",icon:"‚õ∞Ô∏è",x:60,y:70} },
      routes:[ {from:"timika",to:"enarotali",cost:32}, {from:"enarotali",to:"mulia",cost:25}, {from:"mulia",to:"wamena",cost:28}, {from:"enarotali",to:"wamena",cost:52} ] },
    { id:46, name:"Misi Buah Merah", icon:"üî¥", desc:"Beli buah merah dari Nabire, jual ke Jayapura!", item:{name:"Buah Merah",icon:"üî¥",buyPrice:30,sellPrice:55}, startNode:"jayapura", factoryNode:"nabire", marketNode:"jayapura", targetProfit:48,
      nodes:{ jayapura:{name:"Jayapura",icon:"üèôÔ∏è",x:85,y:40}, sarmi:{name:"Sarmi",icon:"üèòÔ∏è",x:60,y:55}, nabire:{name:"Nabire",icon:"üî¥",x:15,y:50}, biak:{name:"Biak",icon:"üèùÔ∏è",x:45,y:25} },
      routes:[ {from:"jayapura",to:"sarmi",cost:28}, {from:"sarmi",to:"biak",cost:30}, {from:"biak",to:"nabire",cost:25}, {from:"sarmi",to:"nabire",cost:52} ] },
    { id:47, name:"Misi Udang Papua", icon:"ü¶ê", desc:"Beli udang dari Merauke, jual ke Timika!", item:{name:"Udang Galah",icon:"ü¶ê",buyPrice:35,sellPrice:62}, startNode:"timika", factoryNode:"merauke", marketNode:"timika", targetProfit:50,
      nodes:{ timika:{name:"Timika",icon:"üèôÔ∏è",x:15,y:45}, agats:{name:"Agats",icon:"üèòÔ∏è",x:40,y:60}, merauke:{name:"Merauke",icon:"ü¶ê",x:85,y:50}, tanah_merah:{name:"T.Merah",icon:"üåæ",x:60,y:30} },
      routes:[ {from:"timika",to:"agats",cost:28}, {from:"agats",to:"tanah_merah",cost:32}, {from:"tanah_merah",to:"merauke",cost:25}, {from:"agats",to:"merauke",cost:55} ] },
    { id:48, name:"Misi Cenderawasih", icon:"ü¶ú", desc:"Beli kerajinan dari Biak, jual ke Sorong!", item:{name:"Kerajinan Khas",icon:"ü¶ú",buyPrice:55,sellPrice:95}, startNode:"sorong", factoryNode:"biak", marketNode:"sorong", targetProfit:65,
      nodes:{ sorong:{name:"Sorong",icon:"üèôÔ∏è",x:15,y:45}, manokwari:{name:"Manokwari",icon:"üèòÔ∏è",x:45,y:30}, biak:{name:"Biak",icon:"ü¶ú",x:85,y:40}, nabire:{name:"Nabire",icon:"üèòÔ∏è",x:60,y:65} },
      routes:[ {from:"sorong",to:"manokwari",cost:28}, {from:"manokwari",to:"nabire",cost:30}, {from:"nabire",to:"biak",cost:25}, {from:"manokwari",to:"biak",cost:52} ] },
    { id:49, name:"Misi Keladi", icon:"ü•î", desc:"Beli keladi dari Elelim, jual ke Jayapura!", item:{name:"Keladi",icon:"ü•î",buyPrice:12,sellPrice:25}, startNode:"jayapura", factoryNode:"elelim", marketNode:"jayapura", targetProfit:30,
      nodes:{ jayapura:{name:"Jayapura",icon:"üèôÔ∏è",x:15,y:40}, sentani:{name:"Sentani",icon:"üèòÔ∏è",x:35,y:60}, elelim:{name:"Elelim",icon:"ü•î",x:85,y:45}, wamena:{name:"Wamena",icon:"‚õ∞Ô∏è",x:60,y:30} },
      routes:[ {from:"jayapura",to:"sentani",cost:12}, {from:"sentani",to:"wamena",cost:35}, {from:"wamena",to:"elelim",cost:22}, {from:"sentani",to:"elelim",cost:50} ] },
    { id:50, name:"Misi Emas Papua", icon:"ü•á", desc:"Beli emas dari Timika, jual ke Jayapura!", item:{name:"Emas",icon:"ü•á",buyPrice:150,sellPrice:250}, startNode:"jayapura", factoryNode:"timika", marketNode:"jayapura", targetProfit:120,
      nodes:{ jayapura:{name:"Jayapura",icon:"üèôÔ∏è",x:85,y:35}, sentani:{name:"Sentani",icon:"üèòÔ∏è",x:65,y:55}, timika:{name:"Timika",icon:"ü•á",x:15,y:50}, nabire:{name:"Nabire",icon:"üèòÔ∏è",x:40,y:35} },
      routes:[ {from:"jayapura",to:"sentani",cost:12}, {from:"sentani",to:"nabire",cost:38}, {from:"nabire",to:"timika",cost:32}, {from:"sentani",to:"timika",cost:65} ] }
];

// ========== STATE ==========
let playerData = { name:"Saudagar Cilik", totalCoins:0, missionsCompleted:0, totalStars:0, bestProfit:0 };
let state = { coins:500, stock:0, currentLevel:0, phase:1, currentNode:null, targetNode:null, selectedPath:[], totalSpentOnTravel:0, totalSpentOnGoods:0, unlockedLevels:1, levelStars:{} };
let previousScreen = 'screen-main';
let dialogState = { isActive:false, currentDialogs:[], currentIndex:0, onComplete:null };

// ========== LOAD/SAVE ==========
function loadPlayerData() {
    const saved = localStorage.getItem('saudagarCilikPlayer');
    if (saved) playerData = JSON.parse(saved);
    const savedState = localStorage.getItem('saudagarCilikState');
    if (savedState) { const s = JSON.parse(savedState); state.unlockedLevels = s.unlockedLevels || 1; state.levelStars = s.levelStars || {}; }
}
function savePlayerData() {
    localStorage.setItem('saudagarCilikPlayer', JSON.stringify(playerData));
    localStorage.setItem('saudagarCilikState', JSON.stringify({ unlockedLevels: state.unlockedLevels, levelStars: state.levelStars }));
}
function savePlayerName() { playerData.name = document.getElementById('player-name-input').value || "Saudagar Cilik"; savePlayerData(); updateTopBar(); }

// ========== RANK ==========
function getCurrentRank() { let r = rankSystem[0]; for (let i = rankSystem.length-1; i >= 0; i--) { if (playerData.totalCoins >= rankSystem[i].minCoins) { r = rankSystem[i]; break; } } return r; }

// ========== SCREEN ==========
function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function showTitle() { document.getElementById('top-bar').style.display = 'none'; switchScreen('screen-title'); }
function startGame() { 
    // Tampilkan intro cutscene dulu
    showIntro();
}
function goBack() { switchScreen(previousScreen); }

// ========== ISLAND SYSTEM ==========
let currentIsland = 'jawa';

function switchIsland(island) {
    // Check if island is locked
    if (island === 'sumatera' && state.unlockedLevels < 11) { alert('üîí Selesaikan Pulau Jawa dulu!'); return; }
    if (island === 'kalimantan' && state.unlockedLevels < 21) { alert('üîí Selesaikan Pulau Sumatera dulu!'); return; }
    if (island === 'sulawesi' && state.unlockedLevels < 31) { alert('üîí Selesaikan Pulau Kalimantan dulu!'); return; }
    if (island === 'papua' && state.unlockedLevels < 41) { alert('üîí Selesaikan Pulau Sulawesi dulu!'); return; }
    
    currentIsland = island;
    // Update tabs
    document.querySelectorAll('.island-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + island).classList.add('active');
    // Update content
    document.querySelectorAll('.island-content').forEach(c => c.classList.remove('active'));
    document.getElementById('island-' + island).classList.add('active');
}

function updateIslandTabs() {
    const tabSumatera = document.getElementById('tab-sumatera');
    const tabKalimantan = document.getElementById('tab-kalimantan');
    const tabSulawesi = document.getElementById('tab-sulawesi');
    const tabPapua = document.getElementById('tab-papua');
    
    if (state.unlockedLevels >= 11) tabSumatera.classList.remove('locked');
    else tabSumatera.classList.add('locked');
    
    if (state.unlockedLevels >= 21) tabKalimantan.classList.remove('locked');
    else tabKalimantan.classList.add('locked');
    
    if (state.unlockedLevels >= 31) tabSulawesi.classList.remove('locked');
    else tabSulawesi.classList.add('locked');
    
    if (state.unlockedLevels >= 41) tabPapua.classList.remove('locked');
    else tabPapua.classList.add('locked');
}

function renderAllLevelGrids() {
    renderLevelGridForIsland('jawa', levels, 0);
    renderLevelGridForIsland('sumatera', levelsSumatera, 10);
    renderLevelGridForIsland('kalimantan', levelsKalimantan, 20);
    renderLevelGridForIsland('sulawesi', levelsSulawesi, 30);
    renderLevelGridForIsland('papua', levelsPapua, 40);
}

function renderLevelGridForIsland(island, levelList, offset) {
    const grid = document.getElementById('level-grid-' + island);
    grid.innerHTML = '';
    levelList.forEach((lv, i) => {
        const btn = document.createElement('button');
        const globalIdx = offset + i;
        const unlocked = globalIdx < state.unlockedLevels;
        const stars = state.levelStars[lv.id] || 0;
        btn.className = `level-btn ${unlocked ? 'unlocked' : 'locked'}`;
        btn.innerHTML = `<span>${lv.icon}</span><span class="level-btn-stars">${unlocked && stars > 0 ? '‚≠ê'.repeat(stars) : (unlocked ? '' : 'üîí')}</span>`;
        if (unlocked) btn.onclick = () => startLevel(globalIdx);
        grid.appendChild(btn);
    });
}

function getAllLevels() {
    return [...levels, ...levelsSumatera, ...levelsKalimantan, ...levelsSulawesi, ...levelsPapua];
}

// ========== TOP BAR ==========
function updateTopBar() {
    const rank = getCurrentRank();
    document.getElementById('topbar-avatar').textContent = rank.avatar;
    document.getElementById('topbar-name').textContent = playerData.name;
    document.getElementById('topbar-rank').textContent = rank.icon + ' ' + rank.name.split(' ').pop();
    // Mini leaderboard
    const lb = [...fakeLeaderboard, { name: playerData.name, coins: playerData.totalCoins, isPlayer: true }].sort((a,b) => b.coins - a.coins).slice(0,3);
    document.getElementById('mini-lb-items').innerHTML = lb.map((e,i) => {
        const cls = i===0 ? 'gold' : i===1 ? 'silver' : 'bronze';
        const medal = i===0 ? 'ü•á' : i===1 ? 'ü•à' : 'ü•â';
        return `<div class="mini-lb-item ${cls}">${medal} ${e.name.substring(0,6)}</div>`;
    }).join('');
}

// ========== PROFILE ==========
function showProfile() {
    previousScreen = document.querySelector('.screen.active').id;
    const rank = getCurrentRank();
    document.getElementById('player-name-input').value = playerData.name;
    document.getElementById('profile-avatar').textContent = rank.avatar;
    document.getElementById('profile-title-badge').textContent = rank.name;
    document.getElementById('rank-badge-icon').textContent = rank.icon;
    document.getElementById('rank-name').textContent = rank.name;
    document.getElementById('rank-desc').textContent = rank.desc;
    document.getElementById('stat-coins').textContent = playerData.totalCoins;
    document.getElementById('stat-missions').textContent = playerData.missionsCompleted;
    document.getElementById('stat-stars').textContent = playerData.totalStars;
    document.getElementById('stat-best').textContent = playerData.bestProfit;
    switchScreen('screen-profile');
}

// ========== LEADERBOARD ==========
function showLeaderboard() {
    previousScreen = document.querySelector('.screen.active').id;
    const lb = [...fakeLeaderboard, { name: playerData.name, coins: playerData.totalCoins, isPlayer: true }].sort((a,b) => b.coins - a.coins).slice(0,10);
    const rank = getCurrentRank();
    document.getElementById('leaderboard-list').innerHTML = lb.map((e,i) => {
        const rcls = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
        const icon = i===0 ? 'ü•á' : i===1 ? 'ü•à' : i===2 ? 'ü•â' : (i+1);
        const pcls = e.isPlayer ? 'current-player' : '';
        return `<div class="leaderboard-item ${pcls}">
            <div class="leaderboard-rank ${rcls}">${icon}</div>
            <div class="leaderboard-avatar">${e.isPlayer ? rank.avatar : 'üë§'}</div>
            <div class="leaderboard-info"><div class="leaderboard-name">${e.name}${e.isPlayer?' (Kamu)':''}</div><div class="leaderboard-title-small">${e.isPlayer?rank.name:'Pedagang'}</div></div>
            <div class="leaderboard-coins">${e.coins} ü™ô</div>
        </div>`;
    }).join('');
    switchScreen('screen-leaderboard');
}

// ========== LEVEL GRID ==========
function renderLevelGrid() {
    const grid = document.getElementById('level-grid');
    grid.innerHTML = '';
    levels.forEach((lv, i) => {
        const btn = document.createElement('button');
        const unlocked = i < state.unlockedLevels;
        const stars = state.levelStars[lv.id] || 0;
        btn.className = `level-btn ${unlocked ? 'unlocked' : 'locked'}`;
        btn.innerHTML = `<span>${lv.icon}</span><span class="level-btn-stars">${unlocked && stars > 0 ? '‚≠ê'.repeat(stars) : (unlocked ? '' : 'üîí')}</span>`;
        if (unlocked) btn.onclick = () => startLevel(i);
        grid.appendChild(btn);
    });
}

// ========== START LEVEL ==========
function startLevel(idx) {
    const allLevels = getAllLevels();
    const lv = allLevels[idx];
    state.currentLevel = idx; state.coins = 500; state.stock = 0; state.phase = 1;
    state.currentNode = lv.startNode; state.targetNode = lv.factoryNode;
    state.selectedPath = [lv.startNode]; state.totalSpentOnTravel = 0; state.totalSpentOnGoods = 0;
    document.getElementById('mission-icon').textContent = lv.icon;
    document.getElementById('mission-title').textContent = lv.name;
    document.getElementById('mission-desc').textContent = lv.desc;
    updatePhaseDisplay();
    switchScreen('screen-game');
    showMissionStartCutscene(lv, 'renderMapPhase()');
}

function updatePhaseDisplay() { for (let i=1; i<=4; i++) { const el = document.getElementById(`phase-${i}`); el.classList.remove('active','done'); if (i < state.phase) el.classList.add('done'); else if (i === state.phase) el.classList.add('active'); } }

// ========== CUTSCENE ==========
function showCutscene(content) { document.getElementById('cutscene-box').innerHTML = content; document.getElementById('cutscene-overlay').classList.add('active'); }
function closeCutscene() { document.getElementById('cutscene-overlay').classList.remove('active'); }

function showMissionStartCutscene(lv, callback) {
    // Tampilkan dialog intro dulu
    const dialogs = getDialogsForLevel(lv);
    showDialog(dialogs.intro, () => {
        // Setelah dialog selesai, tampilkan cutscene misi
        const content = `
            <div class="cutscene-icon animate-bounce">${lv.icon}</div>
            <h2 class="cutscene-title">${lv.name}</h2>
            <p class="cutscene-text">${lv.desc}</p>
            <div class="cutscene-highlight">
                <div class="cutscene-highlight-row"><span>üì¶ Barang</span><span>${lv.item.icon} ${lv.item.name}</span></div>
                <div class="cutscene-highlight-row"><span>üí∞ Modal Awal</span><span>500 ü™ô</span></div>
                <div class="cutscene-highlight-row"><span>üéØ Target Untung</span><span>${lv.targetProfit} ü™ô</span></div>
            </div>
            <button class="btn" style="background: linear-gradient(135deg, #1a5a2e, #2d8a4e); color: white;" onclick="closeCutscene(); ${callback}">Mulai Misi</button>`;
        showCutscene(content);
    });
}

function showTravelingCutscene(fromNode, toNode, lv, callback) {
    const from = lv.nodes[fromNode], to = lv.nodes[toNode];
    
    // Update journey route info - SIMPLIFIED tanpa icon
    document.getElementById('journey-route').innerHTML = `
        <span class="journey-route-from">${from.name}</span>
        <span class="journey-arrow">‚ûú</span>
        <span class="journey-route-to">${to.name}</span>
    `;
    
    // Reset vehicle animation
    const vehicle = document.getElementById('journey-vehicle');
    vehicle.style.animation = 'none';
    vehicle.offsetHeight; // Trigger reflow
    vehicle.style.animation = 'vehicleMove 4s ease-in-out forwards';
    
    // Reset vehicle img bounce
    const vehicleImg = vehicle.querySelector('img');
    vehicleImg.style.animation = 'none';
    vehicleImg.offsetHeight;
    vehicleImg.style.animation = 'vehicleBounce 0.35s ease-in-out infinite';
    
    // Show journey overlay
    document.getElementById('journey-overlay').classList.add('active');
    
    // Hide after animation completes
    setTimeout(() => { 
        document.getElementById('journey-overlay').classList.remove('active');
        if (callback) callback(); 
    }, 4000);
}

function showArrivedAtFactoryCutscene(lv, callback) {
    const dialogs = getDialogsForLevel(lv);
    const factoryName = lv.nodes[lv.factoryNode].name;
    
    const content = `
        <div class="cutscene-icon">üè≠</div>
        <h2 class="cutscene-title">Sampai di ${factoryName}!</h2>
        <p class="cutscene-text">Kamu sudah tiba di tempat produksi ${lv.item.icon} ${lv.item.name}. Saatnya bertemu dengan penjual!</p>
        <button class="btn" style="background: linear-gradient(135deg, #1a5a2e, #2d8a4e); color: white;" onclick="closeCutscene(); showFactoryDialog()">Temui Penjual</button>`;
    showCutscene(content);
    
    window.factoryDialogCallback = callback;
    window.currentLevelDialogs = dialogs;
}

function showFactoryDialog() {
    showDialog(window.currentLevelDialogs.factory, () => {
        if (window.factoryDialogCallback) eval(window.factoryDialogCallback);
    });
}

function showArrivedAtMarketCutscene(lv, callback) {
    const dialogs = getDialogsForLevel(lv);
    const marketName = lv.nodes[lv.marketNode].name;
    
    const content = `
        <div class="cutscene-icon">üè™</div>
        <h2 class="cutscene-title">Sampai di Pasar ${marketName}!</h2>
        <p class="cutscene-text">Kamu membawa ${state.stock} ${lv.item.icon} ${lv.item.name}. Saatnya menjual dan mendapat keuntungan!</p>
        <button class="btn" style="background: linear-gradient(135deg, #1a5a2e, #2d8a4e); color: white;" onclick="closeCutscene(); showMarketDialog()">Temui Pembeli</button>`;
    showCutscene(content);
    
    window.marketDialogCallback = callback;
    window.currentLevelDialogs = dialogs;
}

function showMarketDialog() {
    showDialog(window.currentLevelDialogs.market, () => {
        if (window.marketDialogCallback) eval(window.marketDialogCallback);
    });
}

function showBoughtCutscene(lv, qty, totalCost, callback) {
    const content = `
        <div class="cutscene-icon">‚úÖ</div>
        <h2 class="cutscene-title">Berhasil Membeli!</h2>
        <div class="cutscene-item-display">
            <div class="cutscene-item-icon">${lv.item.icon}</div>
            <div class="cutscene-item-info">
                <div class="cutscene-item-name">${lv.item.name}</div>
                <div class="cutscene-item-qty">${qty} buah</div>
            </div>
        </div>
        <div class="cutscene-highlight">
            <div class="cutscene-highlight-row"><span>üí∏ Total Bayar</span><span>${totalCost} ü™ô</span></div>
            <div class="cutscene-highlight-row"><span>üí∞ Sisa Koin</span><span>${state.coins} ü™ô</span></div>
        </div>
        <p class="cutscene-text">Sekarang pergi ke ${lv.nodes[lv.marketNode].name} untuk menjual barang daganganmu!</p>
        <button class="btn" style="background: linear-gradient(135deg, #1a5a2e, #2d8a4e); color: white;" onclick="closeCutscene(); ${callback}">Ke Pasar</button>`;
    showCutscene(content);
}

// ========== MAP ==========
function renderMapPhase() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    const targetName = state.phase === 1 ? lv.nodes[lv.factoryNode].name + " (Pabrik)" : lv.nodes[lv.marketNode].name + " (Pasar)";
    
    // Tentukan pulau berdasarkan level
    let islandClass = 'map-jawa'; // default
    if (state.currentLevel >= 0 && state.currentLevel < 10) {
        islandClass = 'map-jawa';
    } else if (state.currentLevel >= 10 && state.currentLevel < 20) {
        islandClass = 'map-sumatera';
    } else if (state.currentLevel >= 20 && state.currentLevel < 30) {
        islandClass = 'map-kalimantan';
    } else if (state.currentLevel >= 30 && state.currentLevel < 40) {
        islandClass = 'map-sulawesi';
    } else if (state.currentLevel >= 40) {
        islandClass = 'map-papua';
    }
    
    document.getElementById('game-content').innerHTML = `
        <div class="map-container">
            <div class="map-title">üìç Tujuan: ${targetName}</div>
            <div class="map-area ${islandClass}" id="map-area"></div>
            <div class="path-info">
                <h4>üõ§Ô∏è Jalur:</h4>
                <div class="path-display" id="path-display"><span class="path-node">${lv.nodes[state.currentNode].name}</span></div>
                <div class="path-cost">Ongkos: <span id="path-cost">0</span> ü™ô</div>
                <div style="margin-top:15px;">
                    <button class="btn btn-reset" onclick="resetPath()">üîÑ Reset</button>
                    <button class="btn btn-go" id="btn-go" onclick="confirmPath()" disabled>‚úì Berangkat!</button>
                </div>
            </div>
        </div>`;
    renderMap();
}

function renderMap() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    const mapArea = document.getElementById('map-area');
    mapArea.innerHTML = '';
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'map-svg'); svg.setAttribute('viewBox', '0 0 100 100'); svg.setAttribute('preserveAspectRatio', 'none');
    mapArea.appendChild(svg);
    lv.routes.forEach(r => {
        const f = lv.nodes[r.from], t = lv.nodes[r.to];
        const sel = isRouteInPath(r.from, r.to);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', f.x); line.setAttribute('y1', f.y); line.setAttribute('x2', t.x); line.setAttribute('y2', t.y);
        line.setAttribute('class', `route-line ${sel ? 'selected' : ''}`);
        svg.appendChild(line);
        const label = document.createElement('div');
        label.className = `route-cost-label ${sel ? 'selected' : ''}`;
        label.style.left = `${(f.x + t.x) / 2}%`; label.style.top = `${(f.y + t.y) / 2}%`;
        label.textContent = `${r.cost}ü™ô`;
        mapArea.appendChild(label);
    });
    Object.keys(lv.nodes).forEach(nid => {
        const n = lv.nodes[nid];
        const el = document.createElement('div');
        el.className = 'map-node';
        el.style.left = `${n.x}%`; el.style.top = `${n.y}%`;
        const isStart = nid === state.currentNode && state.selectedPath.length === 1;
        const isTarget = nid === state.targetNode;
        const isInPath = state.selectedPath.includes(nid);
        if (isStart && !isTarget) el.classList.add('current');
        if (isTarget) el.classList.add('target');
        if (isInPath && !isStart) el.classList.add('in-path');
        el.innerHTML = `<span class="node-icon">${n.icon}</span><span class="node-name">${n.name}</span>`;
        el.onclick = () => selectNode(nid);
        mapArea.appendChild(el);
    });
}

function isRouteInPath(from, to) {
    for (let i = 0; i < state.selectedPath.length - 1; i++) {
        if ((state.selectedPath[i] === from && state.selectedPath[i+1] === to) || (state.selectedPath[i] === to && state.selectedPath[i+1] === from)) return true;
    }
    return false;
}

function selectNode(nid) {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    const last = state.selectedPath[state.selectedPath.length - 1];
    const route = lv.routes.find(r => (r.from === last && r.to === nid) || (r.to === last && r.from === nid));
    if (!route || state.selectedPath.includes(nid)) return;
    state.selectedPath.push(nid);
    updatePathDisplay();
    renderMap();
    document.getElementById('btn-go').disabled = nid !== state.targetNode;
}

function updatePathDisplay() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    let html = '', cost = 0;
    state.selectedPath.forEach((nid, i) => {
        html += `<span class="path-node">${lv.nodes[nid].name}</span>`;
        if (i < state.selectedPath.length - 1) {
            html += `<span class="path-arrow">‚Üí</span>`;
            const next = state.selectedPath[i + 1];
            const r = lv.routes.find(r => (r.from === nid && r.to === next) || (r.to === nid && r.from === next));
            if (r) cost += r.cost;
        }
    });
    document.getElementById('path-display').innerHTML = html;
    document.getElementById('path-cost').textContent = cost;
}

function resetPath() {
    state.selectedPath = [state.currentNode];
    updatePathDisplay(); renderMap();
    document.getElementById('btn-go').disabled = true;
}

function confirmPath() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    const startNode = state.selectedPath[0], endNode = state.selectedPath[state.selectedPath.length - 1];
    let cost = 0;
    for (let i = 0; i < state.selectedPath.length - 1; i++) {
        const r = lv.routes.find(r => (r.from === state.selectedPath[i] && r.to === state.selectedPath[i+1]) || (r.to === state.selectedPath[i] && r.from === state.selectedPath[i+1]));
        if (r) cost += r.cost;
    }
    state.coins -= cost; state.totalSpentOnTravel += cost; state.currentNode = state.targetNode;
    showTravelingCutscene(startNode, endNode, lv, () => {
        if (state.phase === 1) { 
            state.phase = 2; 
            updatePhaseDisplay(); 
            // Tampilkan cutscene sampai di pabrik dengan dialog NPC
            showArrivedAtFactoryCutscene(lv, 'renderBuyPhase()');
        }
        else if (state.phase === 3) { 
            state.phase = 4; 
            updatePhaseDisplay(); 
            // Tampilkan cutscene sampai di pasar dengan dialog NPC
            showArrivedAtMarketCutscene(lv, 'renderSellPhase()');
        }
    });
}

// ========== BUY ==========
function renderBuyPhase() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    const item = lv.item, maxQty = Math.floor(state.coins / item.buyPrice);
    document.getElementById('game-content').innerHTML = `
        <div class="trade-panel">
            <div class="trade-icon">üè≠</div>
            <h2 class="trade-title">Pabrik ${lv.nodes[lv.factoryNode].name}</h2>
            <p class="trade-desc">Beli barang sebanyak-banyaknya!</p>
            <div class="trade-item"><div class="trade-item-icon">${item.icon}</div><div class="trade-item-name">${item.name}</div><div class="trade-item-price">${item.buyPrice} ü™ô/buah</div></div>
            <div class="trade-quantity">
                <button class="qty-btn minus" onclick="changeQty(-1)">‚àí</button>
                <div class="qty-display" id="qty-display">0</div>
                <button class="qty-btn plus" onclick="changeQty(1)">+</button>
            </div>
            <div class="trade-total">Total: <span id="buy-total">0</span> ü™ô<br><small>(Max: ${maxQty} buah)</small></div>
            <button class="btn" onclick="confirmBuy()">üõí Beli</button>
        </div>`;
    window.buyQty = 0;
}

function changeQty(d) {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel], maxQty = Math.floor(state.coins / lv.item.buyPrice);
    window.buyQty = Math.max(0, Math.min(maxQty, window.buyQty + d));
    document.getElementById('qty-display').textContent = window.buyQty;
    document.getElementById('buy-total').textContent = window.buyQty * lv.item.buyPrice;
}

function confirmBuy() {
    if (window.buyQty === 0) { alert('Pilih jumlah!'); return; }
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel], cost = window.buyQty * lv.item.buyPrice;
    state.coins -= cost; state.stock = window.buyQty; state.totalSpentOnGoods = cost;
    showBoughtCutscene(lv, window.buyQty, cost, 'goToMarket()');
}

function goToMarket() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel];
    state.phase = 3; state.targetNode = lv.marketNode; state.selectedPath = [state.currentNode];
    updatePhaseDisplay(); renderMapPhase();
}

// ========== SELL ==========
function renderSellPhase() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel], item = lv.item, total = state.stock * item.sellPrice;
    document.getElementById('game-content').innerHTML = `
        <div class="trade-panel">
            <div class="trade-icon">üè™</div>
            <h2 class="trade-title">Pasar ${lv.nodes[lv.marketNode].name}</h2>
            <p class="trade-desc">Jual semua barangmu!</p>
            <div class="trade-item"><div class="trade-item-icon">${item.icon}</div><div class="trade-item-name">${item.name} x${state.stock}</div><div class="trade-item-price">${item.sellPrice} ü™ô/buah</div></div>
            <div class="trade-total" style="font-size:1.4rem; margin:20px 0;">Hasil: <span style="color:#4CAF50;">${total}</span> ü™ô</div>
            <button class="btn" onclick="confirmSell()">üí∞ Jual Semua!</button>
        </div>`;
}

function confirmSell() {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel], total = state.stock * lv.item.sellPrice;
    state.coins += total;
    const profit = total - state.totalSpentOnGoods - state.totalSpentOnTravel;
    let stars = 1; if (profit >= lv.targetProfit) stars = 2; if (profit >= lv.targetProfit * 1.5) stars = 3;
    if (!state.levelStars[lv.id] || state.levelStars[lv.id] < stars) state.levelStars[lv.id] = stars;
    if (state.currentLevel + 1 >= state.unlockedLevels && state.currentLevel + 1 < allLevels.length) state.unlockedLevels = state.currentLevel + 2;
    if (profit > 0) { playerData.totalCoins += profit; playerData.missionsCompleted++; if (profit > playerData.bestProfit) playerData.bestProfit = profit; }
    playerData.totalStars = Object.values(state.levelStars).reduce((a, b) => a + b, 0);
    savePlayerData(); updateTopBar();
    renderResult(total, profit, stars);
}

function renderResult(total, profit, stars) {
    const allLevels = getAllLevels();
    const lv = allLevels[state.currentLevel], win = profit > 0;
    document.getElementById('game-content').innerHTML = `
        <div class="result-panel">
            <div class="result-icon">${win ? 'üéâ' : 'üò¢'}</div>
            <h2 class="result-title" style="color:${win ? '#4CAF50' : '#f44336'};">${win ? 'Berhasil!' : 'Rugi!'}</h2>
            <div class="result-stars">${'‚≠ê'.repeat(stars)}${'‚òÜ'.repeat(3-stars)}</div>
            <div class="result-breakdown">
                <div class="result-row"><span>Hasil Jual</span><span>+${total} ü™ô</span></div>
                <div class="result-row"><span>Beli Barang</span><span style="color:#f44336;">-${state.totalSpentOnGoods} ü™ô</span></div>
                <div class="result-row"><span>Ongkir</span><span style="color:#f44336;">-${state.totalSpentOnTravel} ü™ô</span></div>
                <div class="result-row"><span>UNTUNG</span><span style="color:${profit>=0?'#4CAF50':'#f44336'};">${profit>=0?'+':''}${profit} ü™ô</span></div>
            </div>
            <button class="btn" onclick="backToMenu()">üó∫Ô∏è Pilih Misi</button>
        </div>`;
}

function backToMenu() { updateIslandTabs(); renderAllLevelGrids(); switchScreen('screen-main'); }

// ========== MISSION DIALOG - FULLSCREEN STYLE ==========
let missionDialogState = { 
    currentIndex: 0, 
    isActive: false,
    isTyping: false,
    typingTimeout: null,
    fullText: '',
    currentChar: 0,
    dialogs: [],
    onComplete: null
};

function showDialog(dialogs, onComplete) {
    missionDialogState = { 
        currentIndex: 0, 
        isActive: true,
        isTyping: false,
        typingTimeout: null,
        fullText: '',
        currentChar: 0,
        dialogs: dialogs,
        onComplete: onComplete
    };
    document.getElementById('cutscene-fullscreen').classList.add('active');
    createSparkles();
    renderMissionDialog();
    document.addEventListener('keydown', handleMissionDialogKeydown);
}

function renderMissionDialog() {
    const slide = missionDialogState.dialogs[missionDialogState.currentIndex];
    
    // Update character sprite with image
    const spriteEl = document.getElementById('cs-sprite');
    spriteEl.style.animation = 'none';
    spriteEl.offsetHeight;
    spriteEl.style.animation = 'characterEnter 0.6s ease-out, characterFloat 4s ease-in-out 0.6s infinite';
    
    // Use image if available, otherwise use emoji avatar
    if (slide.image) {
        spriteEl.innerHTML = `<img src="${slide.image}" alt="${slide.name}" class="character-img">`;
    } else if (slide.avatar) {
        spriteEl.innerHTML = slide.avatar;
    }
    
    // Update speaker name
    document.getElementById('cs-speaker').textContent = slide.name;
    
    // Start typing effect
    startMissionTyping(slide.text);
    
    // Update indicator
    document.getElementById('cs-indicator').innerHTML = missionDialogState.dialogs.map((_, i) => 
        `<div class="cutscene-dot ${i < missionDialogState.currentIndex ? 'done' : i === missionDialogState.currentIndex ? 'active' : ''}"></div>`
    ).join('');
    
    // Update button
    updateMissionNextButton();
}

function startMissionTyping(text) {
    if (missionDialogState.typingTimeout) {
        clearTimeout(missionDialogState.typingTimeout);
    }
    
    missionDialogState.fullText = text;
    missionDialogState.currentChar = 0;
    missionDialogState.isTyping = true;
    
    const textEl = document.getElementById('cs-text');
    textEl.innerHTML = '<span class="typing-cursor"></span>';
    
    typeMissionNextChar();
}

function typeMissionNextChar() {
    if (!missionDialogState.isActive) return;
    
    const textEl = document.getElementById('cs-text');
    
    if (missionDialogState.currentChar < missionDialogState.fullText.length) {
        let char = missionDialogState.fullText[missionDialogState.currentChar];
        
        if (char === '<') {
            const closeIndex = missionDialogState.fullText.indexOf('>', missionDialogState.currentChar);
            if (closeIndex !== -1) {
                const tag = missionDialogState.fullText.substring(missionDialogState.currentChar, closeIndex + 1);
                missionDialogState.currentChar = closeIndex + 1;
                const currentHTML = textEl.innerHTML.replace('<span class="typing-cursor"></span>', '');
                textEl.innerHTML = currentHTML + tag + '<span class="typing-cursor"></span>';
                missionDialogState.typingTimeout = setTimeout(typeMissionNextChar, 0);
                return;
            }
        }
        
        const currentHTML = textEl.innerHTML.replace('<span class="typing-cursor"></span>', '');
        textEl.innerHTML = currentHTML + char + '<span class="typing-cursor"></span>';
        missionDialogState.currentChar++;
        
        missionDialogState.typingTimeout = setTimeout(typeMissionNextChar, 25);
    } else {
        missionDialogState.isTyping = false;
        textEl.innerHTML = missionDialogState.fullText;
        updateMissionNextButton();
    }
}

function skipMissionTyping() {
    if (missionDialogState.typingTimeout) {
        clearTimeout(missionDialogState.typingTimeout);
    }
    missionDialogState.isTyping = false;
    document.getElementById('cs-text').innerHTML = missionDialogState.fullText;
    updateMissionNextButton();
}

function updateMissionNextButton() {
    const btn = document.getElementById('cs-next-btn');
    if (missionDialogState.currentIndex < missionDialogState.dialogs.length - 1) {
        btn.textContent = 'Lanjut ‚Üí';
    } else {
        btn.textContent = 'Mulai!';
    }
}

function handleMissionDialogClick() {
    if (missionDialogState.isTyping) {
        skipMissionTyping();
    } else {
        nextMissionDialog();
    }
}

function handleMissionDialogKeydown(e) {
    if (!missionDialogState.isActive) return;
    
    if (e.key === 'Escape') {
        skipMissionDialog();
    } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        handleMissionDialogClick();
    }
}

function nextMissionDialog() {
    missionDialogState.currentIndex++;
    if (missionDialogState.currentIndex >= missionDialogState.dialogs.length) {
        closeMissionDialog();
    } else {
        renderMissionDialog();
    }
}

function skipMissionDialog() {
    closeMissionDialog();
}

function closeMissionDialog() {
    if (missionDialogState.typingTimeout) {
        clearTimeout(missionDialogState.typingTimeout);
    }
    document.removeEventListener('keydown', handleMissionDialogKeydown);
    document.getElementById('cutscene-fullscreen').classList.remove('active');
    missionDialogState.isActive = false;
    
    if (missionDialogState.onComplete) {
        missionDialogState.onComplete();
    }
}

// Update button handlers untuk mission dialog
function handleIntroClick() {
    if (introState.isActive) {
        if (introState.isTyping) {
            skipTyping();
        } else {
            nextIntro();
        }
    } else if (missionDialogState.isActive) {
        handleMissionDialogClick();
    }
}

function skipIntro() {
    if (introState.isActive) {
        closeIntro();
    } else if (missionDialogState.isActive) {
        skipMissionDialog();
    }
}

// Init
loadPlayerData();
</script>
</body>
</html>
